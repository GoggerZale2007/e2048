<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048</title>
    <style>
        :root {
            --bg: #faf8ef; --grid: #bbada0; --tile: #cdc1b4; 
            --text: #776e65; --accent: #8f7a66; --white: #ffffff;
            --block-green: #8bc34a; --block-bg: #4e342e;
        }
        /* THEMES */
        .theme-dark { --bg: #121212; --grid: #2a2a2a; --tile: #3d3d3d; --text: #e0e0e0; --accent: #bb86fc; }
        .theme-neon { --bg: #000; --grid: #1a1a1a; --tile: #333; --text: #00f2ff; --accent: #ff0055; }
        .theme-grass { --bg: #2d5a27; --grid: #1e3d1a; --tile: #3e6b37; --text: #ffffff; --accent: #ffd700; }

        body { 
            background: var(--bg); color: var(--text); font-family: 'Clear Sans', sans-serif;
            margin: 0; height: 100vh; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; align-items: center; transition: 0.3s;
        }

        .view { 
            display: none; position: absolute; width: 100%; height: 100%; 
            flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg); padding: 20px; box-sizing: border-box;
        }
        .active-view { display: flex; z-index: 10; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* e2048 GRID */
        #grid-2048 { 
            display: grid; background: var(--grid); padding: 10px; border-radius: 8px; 
            grid-gap: 10px; position: relative; user-select: none;
        }
        .tile { 
            width: 70px; height: 70px; border-radius: 4px; display: flex; 
            justify-content: center; align-items: center; font-weight: bold;
            transition: all 0.1s; font-size: 24px;
        }

        /* BLOCK BLAST */
        .bb-grid { 
            display: grid; grid-template-columns: repeat(8, 40px); grid-gap: 4px; 
            background: #5d4037; padding: 8px; border-radius: 8px;
        }
        .bb-slot { width: 40px; height: 40px; background: var(--block-bg); border-radius: 4px; transition: 0.2s; }
        .bb-filled { background: var(--block-green); transform: scale(0.95); box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        .tray { display: flex; gap: 15px; margin-top: 30px; height: 100px; }
        .shape-preview { display: grid; gap: 2px; cursor: grab; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 5px; }

        /* UI ELEMENTS */
        .btn { 
            background: var(--accent); color: white; border: none; padding: 12px 20px; 
            border-radius: 6px; font-weight: bold; cursor: pointer; margin: 5px;
            text-transform: uppercase; width: 240px; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .input-field { padding: 12px; border-radius: 6px; border: 1px solid var(--grid); margin-bottom: 10px; width: 220px; }
        
        #toast {
            position: fixed; top: -100px; background: #333; color: white;
            padding: 12px 24px; border-radius: 50px; transition: 0.5s; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="toast">Message</div>

    <div id="view-auth" class="view active-view">
        <h1 style="font-size: 60px; margin: 0;">e2048</h1>
        <div id="auth-form">
            <input type="text" id="auth-user" placeholder="Username" class="input-field"><br>
            <input type="password" id="auth-pass" placeholder="Password" class="input-field"><br>
            
            <div id="auth-login-side">
                <button class="btn" onclick="account.login()">Login</button>
                <p style="font-size: 13px; cursor: pointer;" onclick="account.toggle(true)">New? Register Account</p>
            </div>
            <div id="auth-reg-side" style="display:none">
                <button class="btn" style="background: #28a745" onclick="account.register()">Create Profile</button>
                <p style="font-size: 13px; cursor: pointer;" onclick="account.toggle(false)">Have account? Login</p>
            </div>
        </div>
    </div>

    <div id="view-home" class="view">
        <h2 id="home-user-title">Welcome</h2>
        <button class="btn" onclick="nav('view-modes')">Play e2048</button>
        <button class="btn" onclick="nav('view-block')" style="background:#4caf50">Block Blast</button>
        <button class="btn" onclick="nav('view-stats')" style="background:#607d8b">Lifetime Stats</button>
        <button class="btn" onclick="nav('view-settings')" style="background:#777">Settings</button>
        <button class="btn" onclick="location.reload()" style="background:#d33; width: 100px; font-size: 10px;">Logout</button>
    </div>

    <div id="view-modes" class="view">
        <h3>Challenge Selection</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button class="btn" style="width:120px" onclick="game.start(1024)">1024</button>
            <button class="btn" style="width:120px" onclick="game.start(2048)">2048</button>
            <button class="btn" style="width:120px" onclick="game.start(4096)">4096</button>
            <button class="btn" style="width:120px" onclick="game.start(8192)">8192</button>
            <button class="btn" style="width:120px" onclick="game.start(16384)">16384</button>
            <button class="btn" style="width:120px" onclick="game.start(32768)">32768</button>
            <button class="btn" style="width:120px" onclick="game.start(65536)">65536</button>
            <button class="btn" style="width:120px" onclick="game.start(131072)">131072</button>
        </div>
        <button class="btn" style="width:250px; background:#222" onclick="game.start(Infinity)">Endless Mode</button>
        <div style="margin: 15px;">
            Grid: <button class="btn" style="width:50px" onclick="game.setSize(3)">3x3</button>
            <button class="btn" style="width:50px" onclick="game.setSize(4)">4x4</button>
            <button class="btn" style="width:50px" onclick="game.setSize(5)">5x5</button>
        </div>
        <button class="btn" onclick="nav('view-home')" style="background:#d33">Main Menu</button>
    </div>

    <div id="view-game" class="view">
        <div style="display:flex; justify-content:space-between; width:320px; margin-bottom:10px;">
            <b id="game-mode-label" style="letter-spacing:1px">2048</b>
            <b>Score: <span id="game-score">0</span></b>
        </div>
        <div id="grid-2048"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn" style="width:110px" onclick="game.undo()">Undo</button>
            <button class="btn" style="width:110px; background:#d33" onclick="nav('view-home')">Menu</button>
        </div>
    </div>

    <div id="view-block" class="view">
        <div style="display:flex; justify-content:space-between; width:320px; margin-bottom:10px;">
            <b>BLOCK BLAST</b>
            <b>PTS: <span id="bb-score">0</span></b>
        </div>
        <div class="bb-grid" id="bb-grid"></div>
        <div class="tray" id="bb-tray"></div>
        <button class="btn" onclick="nav('view-home')" style="margin-top:20px;">Quit</button>
    </div>

    <div id="view-stats" class="view">
        <h2>Your Evolution</h2>
        <div id="stats-list" style="text-align:left; width:250px; line-height:2;"></div>
        <hr style="width:250px; opacity:0.2;">
        <h3>Achievements</h3>
        <div id="achievements-list" style="font-size:12px; color:#888;"></div>
        <button class="btn" onclick="nav('view-home')" style="margin-top:20px;">Back</button>
    </div>

    <div id="view-settings" class="view">
        <h2>Settings</h2>
        <button class="btn" onclick="app.setTheme('dark')">Dark Theme</button>
        <button class="btn" onclick="app.setTheme('neon')">Neon Theme</button>
        <button class="btn" onclick="app.setTheme('grass')">Grass Theme</button>
        <button class="btn" onclick="app.setTheme('classic')">Classic Theme</button>
        <button class="btn" onclick="app.toggleHaptics()" style="background:#555">Toggle Haptics</button>
        <button class="btn" onclick="nav('view-home')">Back</button>
    </div>

    <script>
        /* --- GLOBAL APP CONTROL --- */
        let currentUser = null;
        const app = {
            data: JSON.parse(localStorage.getItem('e2048_master')) || { users: {} },
            haptics: true,

            save() { localStorage.setItem('e2048_master', JSON.stringify(this.data)); },

            setTheme(t) {
                document.body.className = 'theme-' + t;
                toast("Theme set to " + t);
            },

            toggleHaptics() {
                this.haptics = !this.haptics;
                toast("Haptics: " + (this.haptics ? "ON" : "OFF"));
            }
        };

        function nav(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.getElementById(id).classList.add('active-view');
            if(id === 'view-block') bb.init();
            if(id === 'view-stats') renderStats();
        }

        function toast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.top = "20px";
            setTimeout(() => t.style.top = "-100px", 3000);
        }

        /* --- ACCOUNT & AUTH --- */
        const account = {
            toggle(reg) {
                document.getElementById('auth-login-side').style.display = reg ? 'none' : 'block';
                document.getElementById('auth-reg-side').style.display = reg ? 'block' : 'none';
            },
            register() {
                const u = document.getElementById('auth-user').value;
                const p = document.getElementById('auth-pass').value;
                if(u.length < 3 || p.length < 3) return alert("Username/Password too short!");
                if(app.data.users[u]) return alert("User already exists!");
                
                app.data.users[u] = { 
                    pass: p, 
                    stats: { merges: 0, highestTile: 0, totalScore: 0, wins: 0 },
                    achievements: [] 
                };
                app.save();
                alert("Account created! Please login.");
                this.toggle(false);
            },
            login() {
                const u = document.getElementById('auth-user').value;
                const p = document.getElementById('auth-pass').value;
                if(app.data.users[u] && app.data.users[u].pass === p) {
                    currentUser = u;
                    document.getElementById('home-user-title').innerText = "Hi, " + u;
                    nav('view-home');
                } else alert("Invalid username or password.");
            }
        };

        /* --- e2048 CORE ENGINE --- */
        const game = {
            grid: [], size: 4, score: 0, target: 2048, history: [],
            setSize(s) { this.size = s; toast(`Grid: ${s}x${s}`); },
            start(t) {
                this.target = t; this.score = 0; this.grid = Array(this.size * this.size).fill(0);
                document.getElementById('grid-2048').style.gridTemplateColumns = `repeat(${this.size}, 1fr)`;
                document.getElementById('game-mode-label').innerText = t === Infinity ? "ENDLESS" : t;
                this.history = []; this.addTile(); this.addTile(); this.render();
                nav('view-game');
            },
            addTile() {
                let empty = this.grid.map((v, i) => v === 0 ? i : null).filter(v => v !== null);
                if(empty.length) this.grid[empty[Math.floor(Math.random() * empty.length)]] = Math.random() > 0.1 ? 2 : 4;
            },
            render() {
                const g = document.getElementById('grid-2048'); g.innerHTML = '';
                this.grid.forEach(v => {
                    const d = document.createElement('div'); d.className = 'tile';
                    d.innerText = v || '';
                    d.style.background = this.getTileColor(v);
                    d.style.color = v > 4 ? '#fff' : '#776e65';
                    if(v >= 10000) d.style.fontSize = "14px";
                    g.appendChild(d);
                });
                document.getElementById('game-score').innerText = this.score;
            },
            getTileColor(v) {
                if(!v) return 'var(--tile)';
                const colors = {2:'#eee4da', 4:'#ede0c8', 8:'#f2b179', 16:'#f59563', 32:'#f67c5f', 64:'#f65e3b', 128:'#edcf72', 256:'#edcc61', 512:'#edc850', 1024:'#edc53f', 2048:'#edc22e'};
                return colors[v] || '#3c3a32';
            },
            move(dir) {
                this.history.push({g: [...this.grid], s: this.score});
                let old = JSON.stringify(this.grid);
                this.executeMove(dir);
                if(old !== JSON.stringify(this.grid)) {
                    this.addTile(); this.render(); this.updateLifetimeStats();
                }
            },
            executeMove(dir) {
                const size = this.size;
                const isVertical = dir === 'U' || dir === 'D';
                const isReverse = dir === 'R' || dir === 'D';

                for (let i = 0; i < size; i++) {
                    let line = [];
                    for (let j = 0; j < size; j++) {
                        let idx = isVertical ? (j * size + i) : (i * size + j);
                        line.push(this.grid[idx]);
                    }
                    if (isReverse) line.reverse();
                    
                    let processed = line.filter(x => x);
                    for (let j = 0; j < processed.length - 1; j++) {
                        if (processed[j] === processed[j + 1]) {
                            processed[j] *= 2;
                            this.score += processed[j];
                            processed.splice(j + 1, 1);
                            if(app.haptics && navigator.vibrate) navigator.vibrate(15);
                        }
                    }
                    while (processed.length < size) processed.push(0);
                    if (isReverse) processed.reverse();

                    for (let j = 0; j < size; j++) {
                        let idx = isVertical ? (j * size + i) : (i * size + j);
                        this.grid[idx] = processed[j];
                    }
                }
            },
            undo() { if(this.history.length) { const p = this.history.pop(); this.grid = p.g; this.score = p.s; this.render(); } },
            updateLifetimeStats() {
                if(!currentUser) return;
                const stats = app.data.users[currentUser].stats;
                const maxInGrid = Math.max(...this.grid);
                if(maxInGrid > stats.highestTile) stats.highestTile = maxInGrid;
                if(this.score > stats.bestScore) stats.bestScore = this.score;
                if(maxInGrid === 131072) { toast("TOUCH GRASS PROTOCOLâ„¢ ACTIVATED"); document.body.className = 'theme-grass'; }
                app.save();
            }
        };

        /* --- BLOCK BLAST ENGINE (Polyominoes) --- */
        const bb = {
            grid: Array(64).fill(0), score: 0,
            shapes: [
                {data: [[1,1,1,1]], color: '#2196f3'},
                {data: [[1,1],[1,1]], color: '#ffeb3b'},
                {data: [[1,1,1],[0,1,0]], color: '#9c27b0'},
                {data: [[1,1,0],[0,1,1]], color: '#4caf50'}
            ],
            init() {
                const g = document.getElementById('bb-grid'); g.innerHTML = '';
                this.grid.fill(0); this.score = 0;
                for(let i=0; i<64; i++) {
                    const s = document.createElement('div'); s.className = 'bb-slot';
                    s.id = `bb-${i}`; g.appendChild(s);
                }
                this.genTray();
                document.getElementById('bb-score').innerText = 0;
            },
            genTray() {
                const tray = document.getElementById('bb-tray'); tray.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const s = this.shapes[Math.floor(Math.random()*this.shapes.length)];
                    const d = document.createElement('div'); d.className = 'shape-preview';
                    d.style.gridTemplateColumns = `repeat(${s.data[0].length}, 15px)`;
                    s.data.flat().forEach(v => {
                        const cell = document.createElement('div');
                        cell.style.width = '15px'; cell.style.height = '15px';
                        if(v) cell.style.background = s.color;
                        d.appendChild(cell);
                    });
                    d.onclick = () => this.tryPlace(s);
                    tray.appendChild(d);
                }
            },
            tryPlace(s) {
                // Simplified placement logic: find first available fit
                for(let i=0; i<64; i++) {
                    if(this.canFit(s.data, i)) {
                        this.doPlace(s.data, i);
                        this.checkClears();
                        if(document.getElementById('bb-tray').children.length === 0) this.genTray();
                        return;
                    }
                }
                toast("No room for that piece!");
            },
            canFit(shape, idx) {
                let r = Math.floor(idx/8), c = idx%8;
                if(r + shape.length > 8 || c + shape[0].length > 8) return false;
                for(let i=0; i<shape.length; i++) {
                    for(let j=0; j<shape[i].length; j++) {
                        if(shape[i][j] && this.grid[(r+i)*8+(c+j)]) return false;
                    }
                }
                return true;
            },
            doPlace(shape, idx) {
                let r = Math.floor(idx/8), c = idx%8;
                for(let i=0; i<shape.length; i++) {
                    for(let j=0; j<shape[i].length; j++) {
                        if(shape[i][j]) {
                            this.grid[(r+i)*8+(c+j)] = 1;
                            document.getElementById(`bb-${(r+i)*8+(c+j)}`).classList.add('bb-filled');
                        }
                    }
                }
                event.target.closest('.shape-preview').remove();
            },
            checkClears() {
                let rows = [], cols = [];
                for(let i=0; i<8; i++) {
                    let rArr = this.grid.slice(i*8, i*8+8);
                    if(rArr.every(v => v === 1)) rows.push(i);
                    let cArr = []; for(let j=0; j<8; j++) cArr.push(this.grid[j*8+i]);
                    if(cArr.every(v => v === 1)) cols.push(i);
                }
                if(rows.length || cols.length) {
                    toast("LINE EXPLOSION!");
                    rows.forEach(r => { for(let c=0; c<8; c++) this.clearIdx(r*8+c); });
                    cols.forEach(c => { for(let r=0; r<8; r++) this.clearIdx(r*8+c); });
                    this.score += (rows.length + cols.length) * 100;
                    document.getElementById('bb-score').innerText = this.score;
                }
            },
            clearIdx(i) {
                this.grid[i] = 0;
                document.getElementById(`bb-${i}`).classList.remove('bb-filled');
            }
        };

        /* --- STATS RENDERING --- */
        function renderStats() {
            if(!currentUser) return;
            const s = app.data.users[currentUser].stats;
            document.getElementById('stats-list').innerHTML = `
                <b>Highest Tile:</b> ${s.highestTile}<br>
                <b>Best Score:</b> ${s.bestScore}<br>
                <b>Total Merges:</b> ${s.merges}
            `;
            document.getElementById('achievements-list').innerText = s.highestTile >= 2048 ? "ðŸ† 2048 Achieved" : "No achievements yet.";
        }

        /* --- INPUTS --- */
        let ts = {x:0, y:0};
        window.addEventListener('touchstart', e => { ts.x = e.touches[0].clientX; ts.y = e.touches[0].clientY; });
        window.addEventListener('touchend', e => {
            if(!document.getElementById('view-game').classList.contains('active-view')) return;
            let dx = e.changedTouches[0].clientX - ts.x, dy = e.changedTouches[0].clientY - ts.y;
            if(Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                if(Math.abs(dx) > Math.abs(dy)) game.move(dx > 0 ? 'R' : 'L');
                else game.move(dy > 0 ? 'D' : 'U');
            }
        });
    </script>
</body>
</html>
