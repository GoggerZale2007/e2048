<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048 - Shared Controls</title>
    <style>
        :root {
            --bg-2048: #faf8ef; --text-2048: #776e65; --board-2048: #bbada0; 
            --cell-2048: rgba(238, 228, 218, 0.35); --score-bg: #bbada0;
            --bp-bg: #a0745b; --bp-board: #674332; --bp-cell: #573727; 
            --bp-green: #71b965; --bp-beige: #dac6a3;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: "Clear Sans", Arial, sans-serif; background: var(--bg-2048); color: var(--text-2048); }
        
        .view { display: none; position: absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; align-items:center; background:inherit; z-index:10; overflow-y:auto; padding:20px 0; }
        .active-view { display: flex; }
        
        .btn { background:#8f7a66; color:#f9f6f2; border:none; padding:12px 24px; border-radius:3px; font-weight:bold; font-size:16px; cursor:pointer; text-transform:uppercase; margin:5px; box-shadow:0 4px 0 rgba(0,0,0,0.1); transition: 0.1s; }
        .btn:active { transform:translateY(2px); box-shadow:none; }
        
        /* HARD LOCK CSS */
        .btn:disabled, .btn[disabled] { 
            background: #dcdcdc !important; 
            color: #aaa !important; 
            cursor: not-allowed !important; 
            box-shadow: none !important; 
            transform: none !important;
            pointer-events: none !important; /* Prevents any clicking */
        }

        .input-field { padding:14px; border-radius:5px; border:2px solid #bbada0; width:280px; font-size:16px; margin-bottom:12px; }
        .top-header { width:340px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .score-box { background:#bbada0; padding:5px 15px; border-radius:3px; color:white; text-align:center; min-width:60px; }
        
        .game-wrapper { position:relative; width:340px; height:340px; background:var(--board-2048); border-radius:6px; padding:10px; touch-action:none; }
        .grid-bg { display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; width:100%; height:100%; }
        .grid-cell { background:var(--cell-2048); border-radius:3px; }
        .tile-layer { position:absolute; top:10px; left:10px; pointer-events:none; width:320px; height:320px; }
        
        .tile { position:absolute; width:72.5px; height:72.5px; border-radius:3px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:32px; transition:transform 100ms; z-index:10; }
        .t2{background:#eee4da;color:#776e65} .t4{background:#ede0c8;color:#776e65} .t8{background:#f2b179;color:#f9f6f2}
        .t1{background:#ff0000; color:#fff; box-shadow: 0 0 10px red;} /* Impossible tile */

        .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(250,248,239,0.98); z-index:1000; display:none; flex-direction:column; align-items:center; justify-content:center; text-align: center; }
        #toast { position:fixed; top:-100px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:30px; transition:0.4s; z-index:9999; }
    </style>
</head>
<body>
    <div id="toast">Notification</div>
    <button id="owner-login-btn" style="position:fixed; top:10px; right:10px; z-index:1100; font-size:10px; padding:5px; opacity:0.5;" class="btn" onclick="owner.promptLogin()">Login as Owner</button>

    <div id="stop-overlay" class="overlay">
        <h1 style="font-size: 50px;">ðŸ›‘</h1>
        <h2>e2048 was stopped by the owner</h2>
        <p>Please wait until e2048 starts again.</p>
        <button class="btn" onclick="document.getElementById('stop-overlay').style.display='none'">I understand</button>
    </div>

    <div id="view-auth" class="view active-view" style="justify-content:center;">
        <h1 style="font-size:80px; margin:0;">e2048</h1>
        <button class="btn" onclick="auth.guest()">Play as Guest</button>
    </div>

    <div id="view-home" class="view">
        <h2 id="welcome-msg">Welcome</h2>
        <button id="owner-panel-btn" class="btn" style="display:none; background:#ffcc00; color:black;" onclick="sys.nav('view-owner')">OWNER CONTROL PANEL</button>
        <button class="btn" onclick="sys.nav('view-modes')">Play 2048</button>
        <button class="btn" style="background:#d33" onclick="auth.logout()">Logout</button>
    </div>

    <div id="view-modes" class="view">
        <button class="btn" onclick="sys.nav('view-home')">Back</button>
        <div id="modes-container" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:20px;">
            <button class="btn mode-btn" data-mode="1024" onclick="game2048.init(1024)">1024</button>
            <button class="btn mode-btn" data-mode="2048" onclick="game2048.init(2048)">2048</button>
            <button class="btn mode-btn" data-mode="4096" onclick="game2048.init(4096)">4096</button>
            <button class="btn mode-btn" data-mode="Endless" onclick="game2048.init(Infinity)">Endless</button>
        </div>
    </div>

    <div id="view-2048" class="view">
        <div class="top-header">
            <h1 id="display-target">2048</h1>
            <div class="score-box"><span id="score-2048">0</span></div>
        </div>
        <div class="game-wrapper" id="board-2048">
            <div class="grid-bg">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
            <div class="tile-layer" id="tile-layer"></div>
        </div>
        <button class="btn" style="margin-top:20px;" onclick="sys.nav('view-modes')">Quit</button>
    </div>

    <div id="view-owner" class="view">
        <h1 style="color:#8f7a66">Owner Control</h1>
        <div style="background:#333; color:white; padding:20px; border-radius:10px; width:320px;">
            <button id="kill-switch" class="btn" style="width:100%" onclick="owner.toggleSystem()">Stop System</button>
            <hr>
            <p>Difficulty: <b id="diff-status">Normal</b></p>
            <button class="btn" onclick="owner.setDifficulty()">Cycle Difficulty</button>
            <hr>
            <p>Toggle Mode Locks:</p>
            <div id="lock-toggles" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div>
        </div>
        <button class="btn" onclick="sys.nav('view-home')">Back</button>
    </div>

    <script>
        const owner = {
            isAdmin: false,
            state: { isStopped: false, difficulty: 2, lockedModes: [] },
            
            promptLogin() {
                if(prompt("Owner Password:") === "luan2022") {
                    this.isAdmin = true;
                    document.getElementById('owner-panel-btn').style.display = "block";
                    sys.toast("Admin Authenticated");
                    this.renderPanel();
                }
            },

            toggleSystem() {
                this.state.isStopped = !this.state.isStopped;
                this.sync();
            },

            setDifficulty() {
                this.state.difficulty = (this.state.difficulty % 4) + 1;
                this.sync();
            },

            toggleLock(m) {
                if(this.state.lockedModes.includes(m)) this.state.lockedModes = this.state.lockedModes.filter(x => x !== m);
                else this.state.lockedModes.push(m);
                this.sync();
            },

            sync() {
                localStorage.setItem('e2048_system_control', JSON.stringify(this.state));
                this.applyToAll();
                this.renderPanel();
            },

            applyToAll() {
                const s = JSON.parse(localStorage.getItem('e2048_system_control') || '{"isStopped":false,"difficulty":2,"lockedModes":[]}');
                this.state = s;

                // Stop Check
                if (s.isStopped && !this.isAdmin) {
                    document.getElementById('stop-overlay').style.display = 'flex';
                }

                // Lock Check
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    const m = btn.dataset.mode;
                    if (s.lockedModes.includes(m)) {
                        btn.setAttribute('disabled', 'true');
                    } else {
                        btn.removeAttribute('disabled');
                    }
                });
            },

            renderPanel() {
                document.getElementById('kill-switch').innerText = this.state.isStopped ? "START SYSTEM" : "STOP SYSTEM";
                document.getElementById('kill-switch').style.background = this.state.isStopped ? "#4CAF50" : "#d33";
                const diffs = ["", "Easy", "Normal", "Hard", "Impossible"];
                document.getElementById('diff-status').innerText = diffs[this.state.difficulty];

                const container = document.getElementById('lock-toggles');
                container.innerHTML = '';
                ["1024", "2048", "4096", "Endless"].forEach(m => {
                    const b = document.createElement('button');
                    b.className = "btn";
                    b.style.fontSize = "10px";
                    b.innerText = (this.state.lockedModes.includes(m) ? "Unlock " : "Lock ") + m;
                    b.onclick = () => this.toggleLock(m);
                    container.appendChild(b);
                });
            }
        };

        const sys = {
            nav(id) {
                owner.applyToAll();
                if(owner.state.isStopped && !owner.isAdmin && id !== 'view-auth') return;
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
                document.getElementById(id).classList.add('active-view');
            },
            toast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.top = "20px"; setTimeout(() => t.style.top = "-100px", 2000); }
        };

        const auth = {
            guest() { sys.nav('view-home'); },
            logout() { location.reload(); }
        };

        const game2048 = {
            grid: [], score: 0, target: 2048,
            init(t) {
                owner.applyToAll();
                if(owner.state.lockedModes.includes(t === Infinity ? "Endless" : t.toString()) && !owner.isAdmin) {
                    sys.toast("Mode Locked");
                    return;
                }
                this.target = t; this.grid = Array(16).fill(null); this.score = 0;
                this.spawn(); this.spawn(); this.render();
                sys.nav('view-2048');
            },
            spawn() {
                const empty = this.grid.map((v, i) => v === null ? i : null).filter(v => v !== null);
                if (!empty.length) return;
                
                let val = 2;
                const d = owner.state.difficulty;
                if (d === 1) val = Math.random() < 0.6 ? 2 : 4; 
                else if (d === 3) val = Math.random() < 0.98 ? 2 : 4;
                else if (d === 4) { // Impossible
                    const rand = Math.random();
                    if(rand < 0.1) val = 1; // Spawns a 1 which is useless
                    else if(rand < 0.98) val = 2;
                    else val = 4;
                } else { val = Math.random() < 0.9 ? 2 : 4; }

                this.grid[empty[Math.floor(Math.random() * empty.length)]] = { val: val, isNew: true };
            },
            render() {
                const layer = document.getElementById('tile-layer');
                layer.innerHTML = '';
                this.grid.forEach((t, i) => {
                    if (!t) return;
                    const n = document.createElement('div');
                    n.className = `tile t${t.val}`;
                    n.style.transform = `translate(${(i % 4) * 82.5}px, ${Math.floor(i / 4) * 82.5}px)`;
                    n.innerText = t.val;
                    layer.appendChild(n);
                });
                document.getElementById('score-2048').innerText = this.score;
            }
        };

        window.onload = () => {
            owner.applyToAll();
            setInterval(() => owner.applyToAll(), 1000); // Constant background check
        };
    </script>
</body>
</html>
