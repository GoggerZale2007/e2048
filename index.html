<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048</title>
    <style>
        :root {
            --bg-2048: #faf8ef; --text-2048: #776e65; --board-2048: #bbada0; 
            --cell-2048: rgba(238, 228, 218, 0.35); --score-bg: #bbada0;
            --bp-bg: #a0745b; --bp-board: #674332; --bp-cell: #573727; 
            --bp-green: #71b965; --bp-beige: #dac6a3;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: "Clear Sans", Arial, sans-serif; background: var(--bg-2048); color: var(--text-2048); transition: background 0.3s; }
        
        .view { display: none; position: absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; align-items:center; background:inherit; z-index:10; overflow-y:auto; padding:20px 0; }
        .active-view { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .btn { background:#8f7a66; color:#f9f6f2; border:none; padding:12px 24px; border-radius:3px; font-weight:bold; font-size:16px; cursor:pointer; text-transform:uppercase; margin:5px; box-shadow:0 4px 0 rgba(0,0,0,0.1); width: 280px; }
        .btn:active { transform:translateY(2px); box-shadow:none; }
        .btn:disabled { background: #ccc !important; color: #999 !important; cursor: not-allowed; box-shadow: none; pointer-events: none; }
        
        .input-field { padding:14px; border-radius:5px; border:2px solid #bbada0; width:280px; font-size:16px; margin-bottom:12px; }
        
        .top-header { width:340px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .score-box { background:#bbada0; padding:5px 15px; border-radius:3px; color:white; text-align:center; min-width:65px; }
        .score-label { display:block; font-size:11px; font-weight:bold; color:#eee4da; }
        .score-val { font-size:20px; font-weight:bold; }
        
        .game-wrapper { position:relative; width:340px; height:340px; background:var(--board-2048); border-radius:6px; padding:10px; touch-action:none; }
        .grid-bg { display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; width:100%; height:100%; }
        .grid-cell { background:var(--cell-2048); border-radius:3px; }
        .tile-layer { position:absolute; top:10px; left:10px; pointer-events:none; width:320px; height:320px; }
        
        .tile { position:absolute; width:72.5px; height:72.5px; border-radius:3px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:32px; transition:transform 100ms ease-in-out; z-index:10; pointer-events:auto; }
        .t-new { animation: appear 150ms ease-out forwards; }
        .t-merged { z-index:20; animation: pop 180ms ease-in-out forwards; }
        @keyframes appear { 0% { opacity:0; transform: scale(0); } 100% { opacity:1; transform: scale(1); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        
        /* Tile Styles */
        .t2{background:#eee4da;color:#776e65} .t4{background:#ede0c8;color:#776e65} .t8{background:#f2b179;color:#fff} .t16{background:#f59563;color:#fff} .t32{background:#f67c5f;color:#fff} .t64{background:#f65e3b;color:#fff} .t128{background:#edcf72;color:#fff;font-size:28px} .t256{background:#edcc61;color:#fff;font-size:28px} .t512{background:#edc850;color:#fff;font-size:28px} .t1024{background:#edc53f;color:#fff;font-size:24px} .t2048{background:#edc22e;color:#fff;font-size:24px} .t4096{background:#3c3a32;color:#fff} .t131072{background:#000;color:#00f2ff;text-shadow:0 0 8px #00f2ff; box-shadow:0 0 15px #00f2ff;}

        .bp-score-large { font-size:70px; font-weight:bold; color:white; margin-top:10px; letter-spacing:-2px; }
        .bp-grid-wrapper { background:var(--bp-board); padding:8px; border-radius:4px; box-shadow:0 10px 20px rgba(0,0,0,0.3); touch-action:none; }
        .bp-grid { display:grid; grid-template-columns:repeat(8, 40px); gap:2px; }
        .bp-slot { width:40px; height:40px; background:var(--bp-cell); border-radius:2px; }
        .bp-filled-green { background:var(--bp-green); box-shadow:inset 3px 3px 0 rgba(255,255,255,0.3), inset -3px -3px 0 rgba(0,0,0,0.2); }
        .bp-filled-beige { background:var(--bp-beige); box-shadow:inset 3px 3px 0 rgba(255,255,255,0.4), inset -3px -3px 0 rgba(0,0,0,0.1); }
        .bp-ghost { background:rgba(255,255,255,0.2); }
        .tray { display:flex; justify-content:space-around; width:360px; height:120px; margin-top:30px; }
        .shape { display:grid; gap:2px; cursor:grab; padding:10px; }
        .mini-block { width:20px; height:20px; border-radius:2px; }
        .dragging { position:fixed; z-index:1000; pointer-events:none; }
        .particle { position:fixed; width:8px; height:8px; pointer-events:none; z-index:2000; border-radius:50%; }

        #global-announcement { position: fixed; top: 0; left: 0; width: 100%; background: #ffcc00; color: #333; padding: 10px; font-weight: bold; text-align: center; z-index: 5000; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #toast { position:fixed; top:-100px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:30px; transition:0.4s; z-index:9999; font-weight:bold; }
        .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(250,248,239,0.95); z-index:100; display:none; flex-direction:column; align-items:center; justify-content:center; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div id="toast">Notification</div>
    <div id="global-announcement"></div>

    <div style="position:fixed; top:40px; right:10px; z-index:2000; display:flex; flex-direction:column; gap:5px;">
        <button id="owner-login-btn" class="btn" style="width:115px; font-size:10px; padding:6px; opacity:0.6;" onclick="owner.prompt()">Owner Login</button>
        <button id="admin-login-btn" class="btn" style="width:115px; font-size:10px; padding:6px; opacity:0.6; background:#444;" onclick="adminS.prompt()">Admin Login</button>
    </div>

    <div id="stop-overlay" class="overlay" style="z-index: 10000; background: #faf8ef;">
        <h1 style="font-size: 60px;">ðŸ›‘</h1>
        <h2 style="color:#776e65;">e2048 is under Maintenance</h2>
        <p id="stop-timer-display" style="font-weight: bold; color: #d33; font-size: 18px;"></p>
    </div>

    <div id="view-auth" class="view active-view" style="justify-content:center;">
        <h1 style="font-size:80px; margin:0 0 40px 0; color:#776e65;">e2048</h1>
        <input type="text" id="auth-u" placeholder="Username" class="input-field">
        <input type="password" id="auth-p" placeholder="Password" class="input-field">
        <button class="btn" onclick="authS.login()">Login</button>
        <button class="btn" style="background:#71b965" onclick="authS.register()">Join Now</button>
    </div>

    <div id="view-home" class="view">
        <h1 style="font-size:40px;">e2048</h1>
        <h2 id="welcome-msg" style="margin-bottom:30px; font-size:18px;">Welcome</h2>

        <div id="admin-panel" style="display:none; background:white; padding:15px; border-radius:8px; width:300px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border: 2px solid #444;">
            <p style="margin:0 0 10px 0; font-weight:bold;">ADMIN ACTIONS</p>
            <input type="text" id="admin-msg" placeholder="Broadcast message..." class="input-field" style="width:100%; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
                <button class="btn" style="width:100%; padding:10px; font-size:12px;" onclick="adminS.send()">Send</button>
                <button class="btn" style="width:100%; padding:10px; font-size:12px; background:#777;" onclick="adminS.clear()">Clear</button>
            </div>
        </div>

        <button id="owner-link" class="btn" style="display:none; background:#ffcc00; color:black;" onclick="sys.nav('view-owner')">Owner Panel</button>
        <button class="btn" onclick="sys.nav('view-modes')">Play 2048</button>
        <button class="btn" style="background:#674332" onclick="sys.nav('view-bp')">Block Puzzle</button>
        <button class="btn" style="background:#d33; margin-top:30px;" onclick="authS.logout()">Logout</button>
    </div>

    <div id="view-owner" class="view">
        <h1>Owner Settings</h1>
        <div style="background:white; padding:15px; border-radius:8px; width:340px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:10px;">
            <button id="maint-btn" class="btn" style="width:100%;" onclick="owner.toggleMaint()">ENABLE MAINTENANCE</button>
            <hr>
            <p style="font-weight:bold;">Stop System Timer</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <input type="number" id="stop-val" placeholder="Qty" style="padding:8px;">
                <select id="stop-unit" style="padding:8px;"><option value="60000">Minutes</option><option value="3600000">Hours</option></select>
            </div>
            <button id="stop-btn" class="btn" style="width:100%; margin-top:10px;" onclick="owner.toggleStop()">Apply Stop</button>
            <hr>
            <button class="btn" style="background:#8f7a66; width:100%;" onclick="owner.cycleDiff()">Difficulty: <span id="owner-diff-text">Normal</span></button>
        </div>
        <button class="btn" style="background:#555; margin-top:20px;" onclick="sys.nav('view-home')">Back</button>
    </div>

    <div id="view-modes" class="view">
        <div class="top-header"><button class="btn" style="padding:5px 15px; width:90px;" onclick="sys.nav('view-home')">Back</button><h1>Modes</h1><div style="width:90px;"></div></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:20px;">
            <button class="btn" style="width:150px;" onclick="game.init(1024)">1024</button>
            <button class="btn" style="width:150px;" onclick="game.init(2048)">2048</button>
            <button class="btn" style="width:150px;" onclick="game.init(4096)">4096</button>
            <button class="btn" style="width:150px; background:#000; color:#00f2ff;" onclick="game.init(131072)">131072</button>
            <button class="btn" style="width:150px; background:#f65e3b;" onclick="game.init(Infinity, 60)">Blitz</button>
            <button class="btn" style="width:150px; background:#333;" onclick="game.init(Infinity)">Endless</button>
        </div>
    </div>

    <div id="view-game" class="view">
        <div class="top-header">
            <h1>e2048</h1>
            <div class="score-box"><span class="score-label">SCORE</span><span id="cur-score" class="score-val">0</span></div>
        </div>
        <div id="timer-row" style="display:none; margin-bottom:10px; width:340px;">
            <div class="score-box" style="background:#f65e3b; width:100%;"><span class="score-label" style="color:white">TIME LEFT</span><b id="timer-val" style="font-size:20px; color:white;">0:00</b></div>
        </div>
        <div class="game-wrapper" id="board">
            <div class="grid-bg">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
            <div class="tile-layer" id="tile-layer"></div>
        </div>
        <div style="margin-top:25px; display:flex; gap:12px;">
            <button class="btn" style="width:135px; background:#bbada0;" onclick="game.undo()">Undo</button>
            <button class="btn" style="width:135px; background:#776e65;" onclick="sys.nav('view-home')">Menu</button>
        </div>
    </div>

    <div id="view-bp" class="view" style="background:var(--bp-bg)">
        <div class="top-header"><div style="color:#ffcc00; font-weight:bold; font-size:20px;">ðŸ‘‘ BEST: <span id="best-bp">0</span></div><button class="btn" style="background:none; box-shadow:none; font-size:24px;" onclick="sys.nav('view-home')">âœ•</button></div>
        <div class="bp-score-large" id="score-bp">0</div>
        <div class="bp-grid-wrapper"><div class="bp-grid" id="bp-grid"></div></div>
        <div class="tray" id="tray"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCBFxvZXyI4-vZx5F_wsfwoDjx0Z1j9CgE",
            authDomain: "e2048-f9e5e.firebaseapp.com",
            databaseURL: "https://e2048-f9e5e-default-rtdb.firebaseio.com",
            projectId: "e2048-f9e5e",
            storageBucket: "e2048-f9e5e.firebasestorage.app",
            messagingSenderId: "1055536544520",
            appId: "1:1055536544520:web:e399086e1005510668997a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const fbAuth = firebase.auth();

        const sfx = {
            ctx: null,
            play(freq, type, dur, vol) {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator(), gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + dur);
            },
            merge() { this.play(400, 'sine', 0.15, 0.1); }, highMerge() { this.play(800, 'triangle', 0.3, 0.1); },
            wood() { this.play(200, 'square', 0.05, 0.05); }, blast() { this.play(100, 'sawtooth', 0.3, 0.15); }
        };

        const sys = {
            nav(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view')); document.getElementById(id).classList.add('active-view'); if(id==='view-bp') gameBP.init(); },
            toast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.top = "20px"; setTimeout(() => t.style.top = "-100px", 2500); },
            particles(x, y, color) {
                for(let i=0; i<12; i++) {
                    const p = document.createElement('div'); p.className = 'particle'; p.style.background = color; p.style.left = x + 'px'; p.style.top = y + 'px'; document.body.appendChild(p);
                    const ang = Math.random() * Math.PI * 2, dist = 30 + Math.random() * 50;
                    p.animate([{transform:'translate(0,0) scale(1)', opacity:1}, {transform:`translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px) scale(0)`, opacity:0}], 600).onfinish = () => p.remove();
                }
            }
        };

        const authS = {
            login() { fbAuth.signInWithEmailAndPassword(document.getElementById('auth-u').value + "@e2048.com", document.getElementById('auth-p').value).catch(() => sys.toast("Failed")); },
            register() { fbAuth.createUserWithEmailAndPassword(document.getElementById('auth-u').value + "@e2048.com", document.getElementById('auth-p').value).catch(() => sys.toast("Failed")); },
            logout() { fbAuth.signOut().then(() => location.reload()); }
        };
        fbAuth.onAuthStateChanged(user => { if(user) { sys.nav('view-home'); } else { sys.nav('view-auth'); }});

        const adminS = {
            prompt() { if (prompt("Admin Code:") === "crazyadmin99") { document.getElementById('admin-panel').style.display = 'block'; sys.toast("Admin Access"); }},
            send() { db.ref('announcement').set(document.getElementById('admin-msg').value); },
            clear() { db.ref('announcement').set(""); }
        };
        db.ref('announcement').on('value', snap => {
            const m = snap.val(); const el = document.getElementById('global-announcement');
            if(m) { el.innerText = "ðŸ“¢ " + m; el.style.display = 'block'; } else { el.style.display = 'none'; }
        });

        const owner = {
            isLogged: false, settings: { stopUntil: 0, maint: false, difficulty: 2 },
            init() { db.ref('settings').on('value', snap => { this.settings = snap.val() || { stopUntil: 0, maint: false, difficulty: 2 }; this.apply(); }); setInterval(() => this.apply(), 1000); },
            prompt() { if (prompt("Owner Code:") === "luan2022") { this.isLogged = true; document.getElementById('owner-link').style.display = 'block'; this.render(); }},
            toggleMaint() { this.settings.maint = !this.settings.maint; this.save(); },
            toggleStop() {
                const val = parseFloat(document.getElementById('stop-val').value) || 0;
                const unit = parseFloat(document.getElementById('stop-unit').value);
                this.settings.stopUntil = Date.now() + (val * unit); this.save();
            },
            cycleDiff() { this.settings.difficulty = (this.settings.difficulty % 4) + 1; this.save(); },
            save() { db.ref('settings').set(this.settings); },
            apply() {
                const stopped = (this.settings.maint || Date.now() < this.settings.stopUntil);
                document.getElementById('stop-overlay').style.display = (stopped && !this.isLogged) ? 'flex' : 'none';
                if (Date.now() < this.settings.stopUntil) document.getElementById('stop-timer-display').innerText = `Resume in: ${Math.floor((this.settings.stopUntil - Date.now())/1000)}s`;
                if (this.isLogged) this.render();
            },
            render() { 
                const b = document.getElementById('maint-btn'); b.innerText = "MAINTENANCE: " + (this.settings.maint ? "ON" : "OFF"); b.style.background = this.settings.maint ? "#d33" : "#8f7a66"; 
                document.getElementById('owner-diff-text').innerText = ["", "Easy", "Normal", "Hard", "Insane"][this.settings.difficulty];
            }
        };

        const game = {
            grid: [], score: 0, target: 2048, history: [], idCounter: 0, timer: null, timeLeft: 0, initTime: 0,
            init(t, sec = 0) {
                if(owner.settings.maint && !owner.isLogged) return sys.toast("Locked!");
                clearInterval(this.timer); this.target = t; this.score = 0; this.grid = Array(16).fill(null); this.history = []; this.initTime = sec;
                document.getElementById('display-target').innerText = t === Infinity ? "Endless" : t;
                document.getElementById('tile-layer').innerHTML = ''; document.getElementById('timer-row').style.display = sec > 0 ? 'flex' : 'none';
                if(sec > 0) { this.timeLeft = sec; this.startTimer(); }
                this.spawn(); this.spawn(); this.render(); sys.nav('view-game');
            },
            startTimer() { this.timer = setInterval(() => { this.timeLeft--; document.getElementById('timer-val').innerText = `${Math.floor(this.timeLeft/60)}:${(this.timeLeft%60).toString().padStart(2,'0')}`; if(this.timeLeft <= 0) clearInterval(this.timer); }, 1000); },
            spawn() {
                const empty = this.grid.map((v, i) => v === null ? i : null).filter(v => v !== null);
                if(empty.length) {
                    let val = Math.random() < 0.9 ? 2 : 4;
                    if(owner.settings.difficulty === 4 && Math.random() < 0.05) val = 131072;
                    this.grid[empty[Math.floor(Math.random() * empty.length)]] = { id: this.idCounter++, val: val, isNew: true };
                }
            },
            render() {
                const layer = document.getElementById('tile-layer');
                const currentIds = new Set(this.grid.filter(t => t).map(t => t.id));
                Array.from(layer.children).forEach(n => { if (!currentIds.has(parseInt(n.dataset.id))) n.remove(); });
                this.grid.forEach((t, i) => {
                    if(!t) return;
                    let n = document.querySelector(`.tile[data-id='${t.id}']`);
                    if(!n) { n = document.createElement('div'); n.dataset.id = t.id; n.className = 'tile'; layer.appendChild(n); }
                    n.className = `tile t${t.val} ${t.isNew ? 't-new' : ''}`;
                    n.style.transform = `translate(${(i % 4) * 82.5}px, ${Math.floor(i / 4) * 82.5}px)`;
                    n.innerText = t.val; t.isNew = false;
                });
                document.getElementById('cur-score').innerText = this.score;
            },
            undo() { if(this.history.length) { const s = this.history.pop(); this.grid = s.grid; this.score = s.score; this.render(); } },
            move(dir) {
                const prev = JSON.stringify(this.grid);
                this.history.push({grid: JSON.parse(prev), score: this.score}); if(this.history.length > 30) this.history.shift();
                let moved = false;
                const rotate = (grid) => {
                    let next = Array(16).fill(null);
                    for(let r=0; r<4; r++) for(let c=0; c<4; c++) next[c * 4 + (3 - r)] = grid[r * 4 + c];
                    return next;
                };
                let tempGrid = [...this.grid];
                const rotCount = { 'L': 0, 'U': 1, 'R': 2, 'D': 3 }[dir];
                for(let i=0; i<rotCount; i++) tempGrid = rotate(tempGrid);
                for(let r=0; r<4; r++) {
                    let row = []; for(let c=0; c<4; c++) row.push(tempGrid[r * 4 + c]);
                    let filtered = row.filter(x => x !== null);
                    for(let i=0; i<filtered.length-1; i++) {
                        if(filtered[i].val === filtered[i+1].val) {
                            filtered[i].val *= 2; this.score += filtered[i].val; filtered.splice(i+1, 1); moved = true; sfx.merge();
                        }
                    }
                    while(filtered.length < 4) filtered.push(null);
                    for(let c=0; c<4; c++) tempGrid[r * 4 + c] = filtered[c];
                }
                for(let i=0; i<(4-rotCount)%4; i++) tempGrid = rotate(tempGrid);
                if(JSON.stringify(tempGrid) !== prev) { this.grid = tempGrid; moved = true; }
                if(moved) { this.spawn(); this.render(); } else { this.history.pop(); }
            }
        };

        const gameBP = {
            board: Array(64).fill(0), score: 0,
            shapes: [ 
                {m: [[1,1],[1,1]], c: 'bp-filled-green'}, {m: [[1,1,1,1]], c: 'bp-filled-beige'}, 
                {m: [[1,1,1],[0,1,0]], c: 'bp-filled-green'}, {m: [[1,1,0],[0,1,1]], c: 'bp-filled-beige'},
                {m: [[1]], c: 'bp-filled-green'}, {m: [[1,1,1]], c: 'bp-filled-beige'},
                {m: [[1,0],[1,1],[1,0]], c: 'bp-filled-green'}
            ],
            init() {
                this.board.fill(0); this.score = 0; document.getElementById('score-bp').innerText = 0;
                const g = document.getElementById('bp-grid'); g.innerHTML = ''; 
                for(let i=0; i<64; i++) { const s = document.createElement('div'); s.className = 'bp-slot'; s.id = `bp-c-${i}`; g.appendChild(s); }
                this.spawn();
            },
            spawn() {
                const tray = document.getElementById('tray'); tray.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const s = this.shapes[Math.floor(Math.random()*this.shapes.length)], d = document.createElement('div');
                    d.className = 'shape'; d.dataset.matrix = JSON.stringify(s.m); d.style.gridTemplateColumns = `repeat(${s.m[0].length}, 20px)`;
                    s.m.flat().forEach(v => { const b = document.createElement('div'); b.className = 'mini-block'; if(v) b.classList.add(s.c); d.appendChild(b); });
                    const handleDrag = (e, touch) => this.drag(touch ? e.touches[0] : e, d, s.m, s.c);
                    d.addEventListener('mousedown', e => handleDrag(e, false)); d.addEventListener('touchstart', e => handleDrag(e, true), {passive: false});
                    tray.appendChild(d);
                }
            },
            drag(pt, el, matrix, cls) {
                const clone = el.cloneNode(true); clone.classList.add('dragging'); clone.style.gridTemplateColumns = `repeat(${matrix[0].length}, 40px)`;
                Array.from(clone.children).forEach(c => { c.style.width = '40px'; c.style.height = '40px'; }); document.body.appendChild(clone);
                const move = ev => { ev.preventDefault(); const p = ev.touches ? ev.touches[0] : ev; clone.style.left = p.clientX - 20 + 'px'; clone.style.top = p.clientY - 60 + 'px'; };
                const end = ev => { 
                    const p = ev.changedTouches ? ev.changedTouches[0] : ev;
                    const r = document.getElementById('bp-grid').getBoundingClientRect();
                    const col = Math.round((p.clientX - r.left - 20) / 42), row = Math.round((p.clientY - r.top - 60) / 42);
                    if(this.canPlace(matrix, row, col)) {
                        for(let i=0; i<matrix.length; i++) for(let j=0; j<matrix[0].length; j++) if(matrix[i][j]) {
                            this.board[(row+i)*8+(col+j)] = 1; document.getElementById(`bp-c-${(row+i)*8+(col+j)}`).className = `bp-slot ${cls}`;
                        }
                        this.score += 10; document.getElementById('score-bp').innerText = this.score; el.style.visibility = 'hidden'; el.dataset.used = 'true';
                        if(Array.from(document.getElementById('tray').children).every(n => n.dataset.used)) this.spawn();
                        this.checkLines(); sfx.wood();
                    }
                    clone.remove(); window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', end);
                };
                window.addEventListener('mousemove', move); window.addEventListener('mouseup', end); window.addEventListener('touchmove', move, {passive: false}); window.addEventListener('touchend', end);
            },
            canPlace(m, r, c) { if(r<0 || c<0 || r+m.length>8 || c+m[0].length>8) return false; for(let i=0; i<m.length; i++) for(let j=0; j<m[0].length; j++) if(m[i][j] && this.board[(r+i)*8+(c+j)]) return false; return true; },
            checkLines() {
                let rows = [], cols = [];
                for(let i=0; i<8; i++) { 
                    if (this.board.slice(i*8, i*8+8).every(v => v)) rows.push(i); 
                    let col = []; for(let j=0; j<8; j++) col.push(this.board[j*8+i]);
                    if (col.every(v => v)) cols.push(i);
                }
                rows.forEach(r => { for(let c=0; c<8; c++) { this.board[r*8+c] = 0; document.getElementById(`bp-c-${r*8+c}`).className = 'bp-slot'; } });
                cols.forEach(c => { for(let r=0; r<8; r++) { this.board[r*8+c] = 0; document.getElementById(`bp-c-${r*8+c}`).className = 'bp-slot'; } });
                if(rows.length || cols.length) { this.score += (rows.length + cols.length) * 100; sfx.blast(); }
            }
        };

        window.onload = () => { owner.init(); };
        window.addEventListener('keydown', e => { if(e.key.includes('Arrow')) game.move(e.key[5][0]); });
        const brd = document.getElementById('board'); let tx, ty;
        brd.addEventListener('touchstart', e => { tx = e.touches[0].clientX; ty = e.touches[0].clientY; });
        brd.addEventListener('touchend', e => {
            let dx = e.changedTouches[0].clientX - tx, dy = e.changedTouches[0].clientY - ty;
            if(Math.abs(dx)>30 || Math.abs(dy)>30) game.move(Math.abs(dx)>Math.abs(dy)?(dx>0?'R':'L'):(dy>0?'D':'U'));
        });
    </script>
</body>
</html>
