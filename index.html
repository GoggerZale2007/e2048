<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>e2048</title>
    
    <style>
        /* =========================================================
           I. CSS VARIABLES & COLOR PALETTES
           ========================================================= */
        :root {
            /* 2048 Standard Theme */
            --bg-2048: #faf8ef; 
            --text-2048: #776e65; 
            --board-2048: #bbada0; 
            --cell-2048: rgba(238, 228, 218, 0.35); 
            --score-bg: #bbada0;
            
            /* Block Puzzle Wood Theme */
            --bp-bg: #a0745b; 
            --bp-board: #674332; 
            --bp-cell: #573727; 
            --bp-green: #71b965; 
            --bp-beige: #dac6a3;
            --bp-blue: #3498db;
            --bp-orange: #e67e22;
        }

        /* =========================================================
           II. GLOBAL RESET & BASE STYLES
           ========================================================= */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }

        body { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg-2048); 
            color: var(--text-2048); 
            transition: background 0.4s ease-in-out; 
        }

        /* =========================================================
           III. UI FRAMEWORK & NAVIGATION
           ========================================================= */
        .view { 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            flex-direction: column; 
            align-items: center; 
            background: inherit; 
            z-index: 10; 
            overflow-y: auto; 
            padding: 20px 0; 
        }

        .active-view { 
            display: flex; 
            animation: fadeIn 0.3s ease-out; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .btn { 
            background: #8f7a66; 
            color: #f9f6f2; 
            border: none; 
            padding: 14px 24px; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer; 
            text-transform: uppercase; 
            margin: 6px; 
            transition: all 0.1s ease; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); 
        }

        .btn:active { 
            transform: translateY(4px); 
            box-shadow: none; 
        }

        .input-field { 
            padding: 14px; 
            border-radius: 6px; 
            border: 2px solid #bbada0; 
            width: 280px; 
            font-size: 16px; 
            margin-bottom: 12px; 
            text-align: center;
        }

        /* =========================================================
           IV. NOTIFICATIONS (TOASTS & OVERLAYS)
           ========================================================= */
        #toast { 
            position: fixed; 
            top: -150px; /* Safe distance to hide */
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0, 0, 0, 0.9); 
            color: #fff; 
            padding: 14px 28px; 
            border-radius: 40px; 
            transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
            z-index: 10000; 
            font-weight: bold; 
            pointer-events: none; /* Prevents blocking clicks */
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(250, 248, 239, 0.85); 
            z-index: 100; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            pointer-events: all; /* Blocks touches to the board below */
            touch-action: none;
            backdrop-filter: blur(3px);
        }

        /* =========================================================
           V. 2048 GAME STYLES
           ========================================================= */
        .top-header { 
            width: 340px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }

        .score-box { 
            background: var(--score-bg); 
            padding: 6px 15px; 
            border-radius: 4px; 
            color: white; 
            text-align: center; 
            min-width: 65px; 
        }

        .score-label { 
            display: block; 
            font-size: 11px; 
            font-weight: bold; 
            color: #eee4da; 
            margin-bottom: -2px; 
        }

        .score-val { 
            font-size: 20px; 
            font-weight: bold; 
        }

        .game-wrapper { 
            position: relative; 
            width: 340px; 
            height: 340px; 
            background: var(--board-2048); 
            border-radius: 8px; 
            padding: 10px; 
            touch-action: none; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .grid-bg { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            width: 100%; 
            height: 100%; 
        }

        .grid-cell { 
            background: var(--cell-2048); 
            border-radius: 4px; 
        }

        .tile-layer { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            pointer-events: none; 
            width: 320px; 
            height: 320px; 
        }

        .tile { 
            position: absolute; 
            width: 72.5px; 
            height: 72.5px; 
            border-radius: 4px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
            font-size: 32px; 
            transition: transform 100ms ease-in-out; 
            z-index: 10; 
        }

        /* Tile Color Scale */
        .t2 { background: #eee4da; color: #776e65; } 
        .t4 { background: #ede0c8; color: #776e65; } 
        .t8 { background: #f2b179; color: #f9f6f2; } 
        .t16 { background: #f59563; color: #f9f6f2; } 
        .t32 { background: #f67c5f; color: #f9f6f2; } 
        .t64 { background: #f65e3b; color: #f9f6f2; } 
        .t128 { background: #edcf72; color: #f9f6f2; font-size: 28px; box-shadow: 0 0 10px rgba(237, 207, 114, 0.4); } 
        .t256 { background: #edcc61; color: #f9f6f2; font-size: 28px; box-shadow: 0 0 15px rgba(237, 204, 97, 0.5); } 
        .t512 { background: #edc850; color: #f9f6f2; font-size: 28px; box-shadow: 0 0 20px rgba(237, 200, 80, 0.6); } 
        .t1024 { background: #edc53f; color: #f9f6f2; font-size: 24px; box-shadow: 0 0 25px rgba(237, 197, 63, 0.7); } 
        .t2048 { background: #edc22e; color: #f9f6f2; font-size: 24px; box-shadow: 0 0 30px rgba(237, 194, 46, 0.8); }

        /* =========================================================
           VI. BLOCK PUZZLE STYLES
           ========================================================= */
        .bp-grid { 
            display: grid; 
            grid-template-columns: repeat(8, 40px); 
            gap: 2px; 
            background: var(--bp-board); 
            padding: 10px; 
            border-radius: 6px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .bp-slot { 
            width: 40px; 
            height: 40px; 
            background: var(--bp-cell); 
            border-radius: 2px; 
            transition: background 0.2s ease;
        }

        .bp-filled-green { background: var(--bp-green); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.2); }
        .bp-filled-beige { background: var(--bp-beige); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.3); }
        .bp-filled-blue { background: var(--bp-blue); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.2); }
        .bp-filled-orange { background: var(--bp-orange); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.2); }
        
        .bp-ghost { 
            background: rgba(255,255,255,0.2); 
            transform: scale(0.9);
            border-radius: 4px;
        }

        .tray { 
            display: flex; 
            justify-content: space-around; 
            align-items: center;
            width: 360px; 
            height: 120px; 
            margin-top: 30px; 
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            padding: 10px;
        }

        .dragging { 
            position: fixed; 
            z-index: 1000; 
            pointer-events: none; 
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.4));
        }
    </style>
</head>
<body>

    <div id="toast">Achievement Unlocked!</div>

    <div id="view-auth" class="view active-view" style="justify-content:center;">
        <h1 style="font-size:70px; margin-bottom: 40px;">e2048</h1>
        
        <input type="text" id="reg-u" placeholder="Username" class="input-field" autocomplete="off">
        <input type="password" id="reg-p" placeholder="Password" class="input-field">
        
        <div style="display:flex; flex-direction:column; gap: 5px; margin-top: 10px;">
            <button class="btn" style="width: 280px;" onclick="auth.login()">Sign In</button>
            <button class="btn" style="width: 280px; background:#71b965" onclick="auth.register()">Create Account</button>
        </div>
    </div>

    <div id="view-home" class="view">
        <h2 id="welcome-msg" style="font-size: 32px; margin-bottom: 40px;">Welcome</h2>
        
        <button class="btn" style="width:280px;" onclick="sys.nav('view-modes')">2048 Modes</button>
        <button class="btn" style="width:280px; background:#674332" onclick="sys.nav('view-bp')">Block Puzzle</button>
        <button class="btn" style="width:280px; background:#555" onclick="sys.nav('view-stats')">Player Profile</button>
    </div>

    <div id="view-modes" class="view">
        <div class="top-header">
            <button class="btn" onclick="sys.nav('view-home')">‚Üê</button>
            <h2 style="margin: 0;">Game Modes</h2>
            <div style="width: 60px;"></div>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin: 20px 0; width: 320px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin: 20px 0; width: 320px;">
            <button class="btn" onclick="game2048.init(1024)">1024 Target</button>
            <button class="btn" onclick="game2048.init(2048)">2048 Target</button>
            <button class="btn" onclick="game2048.init(4096)">4096 Target</button>
            <button class="btn" onclick="game2048.init(8192)">8192 Target</button>
            <button class="btn" onclick="game2048.init(16384)">16384 Target</button>
            <button class="btn" onclick="game2048.init(32768)">32768 Target</button>
            <button class="btn" onclick="game2048.init(65536)">65536 Target</button>
            <button class="btn" onclick="game2048.init(131072)">131072 Target</button>
        </div>

        
        <button class="btn" style="width:320px; background:#f65e3b;" onclick="game2048.init(Infinity, 60)">1 Minute Challenge</button>
        <button class="btn" style="width:320px; background:#71b965;" onclick="let s=prompt('Enter time in seconds:', '120'); if(s) game2048.init(Infinity, parseInt(s))">Custom Time Challenge</button>
        <button class="btn" style="width:320px; background:#333;" onclick="game2048.init(Infinity)">Endless Sandbox</button>
    </div>

    <div id="view-2048" class="view">
        <div class="top-header">
            <h2 id="display-target" style="margin:0; font-size: 32px;">2048</h2>
            <div style="display:flex; gap:8px;">
                <div class="score-box">
                    <span class="score-label">SCORE</span>
                    <span class="score-val" id="score-2048">0</span>
                </div>
                <div class="score-box">
                    <span class="score-label">BEST</span>
                    <span class="score-val" id="best-2048">0</span>
                </div>
            </div>
        </div>
        
        <div id="timer-row" style="display:none; width: 340px; margin-bottom:15px; background:#f65e3b; color:white; padding:10px; border-radius:6px; text-align: center; font-weight: bold; box-shadow: 0 4px 0 #c44a2f;">
            TIME REMAINING: <span id="timer-val" style="font-size: 20px; margin-left: 10px;">0:00</span>
        </div>
        
        <div class="game-wrapper" id="board-2048">
            <div class="grid-bg">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
            <div class="tile-layer" id="tile-layer"></div>
            
            <div class="overlay" id="over-2048">
                <h1 id="over-msg" style="color:#776e65; font-size: 40px;">Game Over</h1>
                <button class="btn" onclick="game2048.init(game2048.target, game2048.initTime)">Play Again</button>
                <button class="btn" style="background: #555;" onclick="sys.nav('view-modes')">Return to Menu</button>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:25px; width: 340px;">
            <button class="btn" style="flex: 1; background: #bbada0;" onclick="game2048.undo()">‚Ü© UNDO</button>
            <button class="btn" style="flex: 1; background: #d33; box-shadow: 0 4px 0 #a00;" onclick="sys.nav('view-modes')">‚úñ EXIT</button>
        </div>
    </div>

    <div id="view-bp" class="view" style="background:var(--bp-bg)">
        <div class="top-header">
            <h2 style="color:white; margin:0; font-size: 28px;">Score: <span id="score-bp">0</span></h2>
            <button class="btn" style="background: #e74c3c; box-shadow: 0 4px 0 #c0392b; padding: 10px 15px;" onclick="sys.nav('view-home')">‚úï</button>
        </div>
        
        <div class="bp-grid" id="bp-grid"></div>
        
        <div class="tray" id="tray"></div>
        
        <div class="overlay" id="over-bp" style="background: rgba(103, 67, 50, 0.95); color: white;">
            <h1 style="font-size: 40px; text-shadow: 2px 2px rgba(0,0,0,0.5);">No Moves</h1>
            <button class="btn" style="background: #2ecc71;" onclick="gameBP.init()">Restart Level</button>
        </div>
    </div>

    <div id="view-stats" class="view">
        <h2 style="font-size: 32px; margin-bottom: 20px;">Player Profile</h2>
        
        <div style="background: white; padding: 25px; border-radius: 12px; width: 320px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-size: 18px; line-height: 1.6;">
            <p>Total Tiles Merged: <b id="stat-merges" style="float: right; color: #f65e3b;">0</b></p>
            <p>Highest 2048 Score: <b id="stat-high" style="float: right; color: #f65e3b;">0</b></p>
            <hr style="border: none; border-top: 2px dashed #eee; margin: 20px 0;">
            <h3 style="margin: 0 0 10px 0; color: #bbada0;">Trophy Case</h3>
            <div id="achievements-list" style="display:flex; flex-wrap:wrap; gap:8px;">
                </div>
        </div>
        
        <button class="btn" style="margin-top: 30px; width: 320px;" onclick="sys.nav('view-home')">Return Home</button>
    </div>

    <script>
        /* ---------------------------------------------------------
           1. AUDIO SYNTHESIZER
           Generates procedural sound effects without external files.
           --------------------------------------------------------- */
        const sfx = {
            ctx: null,
            play(f, t, d, v) {
                if(!sys.soundOn) return; 
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = t; 
                osc.frequency.setValueAtTime(f, this.ctx.currentTime);
                gain.gain.setValueAtTime(v, this.ctx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+d);
                
                osc.connect(gain); 
                gain.connect(this.ctx.destination); 
                osc.start(); 
                osc.stop(this.ctx.currentTime+d);
            },
            merge() { this.play(523.25, 'sine', 0.15, 0.1); }, 
            wood() { this.play(120, 'square', 0.08, 0.05); },
            win() { 
                this.play(880, 'sine', 0.1, 0.1); 
                setTimeout(() => this.play(1046, 'sine', 0.3, 0.1), 100); 
            }
        };

        /* ---------------------------------------------------------
           2. CORE SYSTEM MANAGER
           Handles Database, Navigation, Stats, and Global Events.
           --------------------------------------------------------- */
        const sys = {
            db: { users: {} }, 
            user: null, 
            soundOn: true, 
            toastTimer: null,
            
            init() {
                // Load local storage database securely
                const saved = localStorage.getItem('e2048_platinum_db'); 
                if(saved) this.db = JSON.parse(saved);
                this.bindInputs();
            },
            
            nav(id) {
                // Hide toast to prevent it from bleeding into the next screen
                document.getElementById('toast').style.top = "-150px";
                
                // Switch active views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
                document.getElementById(id).classList.add('active-view');
                
                // Swap Background Colors based on game mode
                document.body.style.background = id === 'view-bp' ? 'var(--bp-bg)' : 'var(--bg-2048)';
                
                if(id === 'view-bp') gameBP.init();
                if(id === 'view-stats') this.updateProfile();
            },
            
            toast(message) {
                const t = document.getElementById('toast'); 
                t.innerText = message; 
                t.style.top = "30px"; // Slide down into view
                
                // Clear the old timer to prevent glitching if multiple achievements unlock
                if(this.toastTimer) clearTimeout(this.toastTimer);
                
                this.toastTimer = setTimeout(() => { 
                    t.style.top = "-150px"; // Slide back up
                }, 3500);
            },
            
            save() { 
                localStorage.setItem('e2048_platinum_db', JSON.stringify(this.db)); 
            },
            
            checkAchievement(name) {
                if(!this.user) return; 
                let u = this.db.users[this.user]; 
                if(!u.achievements) u.achievements = [];
                
                if(!u.achievements.includes(name)) { 
                    u.achievements.push(name); 
                    this.save(); 
                    this.toast("üèÜ Achievement: " + name); 
                    sfx.win(); 
                }
            },
            
            updateProfile() {
                if(!this.user) return; 
                const u = this.db.users[this.user];
                
                document.getElementById('stat-merges').innerText = u.totalMerges || 0;
                document.getElementById('stat-high').innerText = u.best2048 || 0;
                
                const list = document.getElementById('achievements-list'); 
                list.innerHTML = '';
                
                if(!u.achievements || u.achievements.length === 0) {
                    list.innerHTML = '<span style="color:#aaa; font-style:italic;">No achievements yet. Keep playing!</span>';
                } else {
                    u.achievements.forEach(a => {
                        const b = document.createElement('span'); 
                        b.style = "background:#edc22e; color:white; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);";
                        b.innerText = a; 
                        list.appendChild(b);
                    });
                }
            },
            
            bindInputs() {
                let tx, ty;
                const b = document.getElementById('board-2048');
                
                // Touch Listeners for Mobile Swiping
                b.addEventListener('touchstart', e => { 
                    tx = e.touches[0].clientX; 
                    ty = e.touches[0].clientY; 
                }, {passive:true});
                
                b.addEventListener('touchend', e => {
                    let dx = e.changedTouches[0].clientX - tx;
                    let dy = e.changedTouches[0].clientY - ty;
                    
                    if(Math.abs(dx) > 35 || Math.abs(dy) > 35) {
                        game2048.move(Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? 'R' : 'L') : (dy > 0 ? 'D' : 'U'));
                    }
                }, {passive:true});
                
                // Keyboard Listeners for Desktop
                window.addEventListener('keydown', e => { 
                    if(e.key.includes('Arrow')) {
                        game2048.move(e.key[5][0]); // Extracts U, D, L, R from ArrowUp, etc.
                    }
                });
            }
        };
        /* ---------------------------------------------------------
           3. AUTHENTICATION MODULE
           Secure local profile loading and registration.
           --------------------------------------------------------- */
        const auth = {
            login() { 
                const u = document.getElementById('reg-u').value.trim(); 
                const p = document.getElementById('reg-p').value.trim();
                
                if (!u) return alert("Please enter a username.");
                
                // Check if the user actually exists in the database
                if (sys.db.users[u]) {
                    // Verify password (allows older accounts without passwords to still log in)
                    if (sys.db.users[u].pass === p || !sys.db.users[u].pass) {
                        this.complete(u);
                    } else {
                        alert("Incorrect password!");
                    }
                } else {
                    alert("Account not found! Please click 'Create Account'.");
                }
            },
            
            register() {
                const u = document.getElementById('reg-u').value.trim();
                const p = document.getElementById('reg-p').value.trim();
                
                if (!u) return alert("Please enter a username.");
                if (u.length < 3) return alert("Username must be at least 3 characters.");
                
                // Prevent overwriting an existing account
                if (sys.db.users[u]) {
                    alert("Username already exists! Please Log In instead.");
                } else {
                    // Create the new user profile and save it
                    sys.db.users[u] = { 
                        pass: p, 
                        achievements: [], 
                        best2048: 0, 
                        totalMerges: 0 
                    }; 
                    sys.save(); 
                    this.complete(u); 
                }
            },
            
            complete(u) { 
                sys.user = u; 
                document.getElementById('welcome-msg').innerText = "Hello, " + u; 
                sys.nav('view-home'); 
            }
        };
        

        /* ---------------------------------------------------------
           4. 2048 GAME ENGINE
           Handles Grid Logic, Spawning, Rendering, and History.
           --------------------------------------------------------- */
        const game2048 = {
            grid: [], 
            score: 0, 
            target: 2048, 
            history: [], 
            timer: null, 
            timeLeft: 0, 
            initTime: 0,
            
            init(t, sec=0) {
                this.target = t; 
                this.score = 0; 
                this.grid = Array(16).fill(null); 
                this.timeLeft = sec; 
                this.initTime = sec;
                
                document.getElementById('over-2048').style.display = 'none';
                document.getElementById('display-target').innerText = t === Infinity ? "ENDLESS" : t;
                document.getElementById('timer-row').style.display = sec > 0 ? 'block' : 'none';
                
                clearInterval(this.timer); 
                if(sec > 0) this.startTimer();
                
                if(sys.user) {
                    document.getElementById('best-2048').innerText = sys.db.users[sys.user].best2048 || 0;
                }
                
                // Spawn the first two tiles
                this.spawn(); 
                this.spawn(); 
                this.render(); 
                sys.nav('view-2048');
            },
            
            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--; 
                    const m = Math.floor(this.timeLeft / 60);
                    const s = this.timeLeft % 60;
                    
                    document.getElementById('timer-val').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                    
                    if(this.timeLeft <= 0) { 
                        clearInterval(this.timer); 
                        this.gameOver("Challenge Complete!"); 
                    }
                }, 1000);
            },
            
            spawn() {
                const empty = this.grid.map((v, i) => v === null ? i : null).filter(v => v !== null);
                if(empty.length) {
                    const idx = empty[Math.floor(Math.random() * empty.length)];
                    this.grid[idx] = { 
                        val: Math.random() < 0.9 ? 2 : 4, 
                        id: Date.now() + Math.random() 
                    };
                }
            },
            
            render() {
                const layer = document.getElementById('tile-layer'); 
                layer.innerHTML = '';
                
                this.grid.forEach((t, i) => {
                    if(!t) return; 
                    const n = document.createElement('div');
                    n.className = `tile t${t.val}`; 
                    
                    // Calculate precise X and Y coordinates based on grid index
                    const x = (i % 4) * 82.5;
                    const y = Math.floor(i / 4) * 82.5;
                    n.style.transform = `translate(${x}px, ${y}px)`;
                    
                    n.innerText = t.val; 
                    layer.appendChild(n);
                });
                
                document.getElementById('score-2048').innerText = this.score;
                
                if(sys.user && this.score > sys.db.users[sys.user].best2048) { 
                    sys.db.users[sys.user].best2048 = this.score; 
                    sys.save(); 
                }
            },
            
            move(dir) {
                // Ignore moves if the Game Over screen is showing
                if(document.getElementById('over-2048').style.display === 'flex') return;
                
                let moved = false; 
                this.history.push(JSON.stringify(this.grid)); // Save state for Undo
                
                const getRow = (idx) => {
                    if(dir === 'L') return [idx*4, idx*4+1, idx*4+2, idx*4+3];
                    if(dir === 'R') return [idx*4+3, idx*4+2, idx*4+1, idx*4];
                    if(dir === 'U') return [idx, idx+4, idx+8, idx+12];
                    return [idx+12, idx+8, idx+4, idx];
                };
                
                for(let i=0; i<4; i++) {
                    let indices = getRow(i);
                    let row = indices.map(idx => this.grid[idx]).filter(v => v);
                    
                    for(let j=0; j<row.length-1; j++) {
                        if(row[j].val === row[j+1].val) {
                            row[j].val *= 2; 
                            this.score += row[j].val; 
                            row.splice(j+1, 1); 
                            moved = true; 
                            sfx.merge();
                            
                            // Database & Achievement Tracking
                            if(sys.user) { 
                                sys.db.users[sys.user].totalMerges++; 
                                sys.save(); 
                            }
                            if(row[j].val === this.target) {
                                sys.checkAchievement(this.target + " Conqueror");
                            }
                        }
                    }
                    
                    while(row.length < 4) row.push(null);
                    
                    indices.forEach((idx, j) => { 
                        if(JSON.stringify(this.grid[idx]) !== JSON.stringify(row[j])) moved = true; 
                        this.grid[idx] = row[j]; 
                    });
                }
                
                if(moved) { 
                    this.spawn(); 
                    this.render(); 
                    if(this.isFull() && !this.canMove()) this.gameOver("Board Locked!"); 
                } else { 
                    this.history.pop(); // Remove history if no move occurred
                }
            },
            
            isFull() { 
                return !this.grid.includes(null); 
            },
            
            canMove() {
                for(let i=0; i<4; i++) {
                    for(let j=0; j<3; j++) {
                        if(this.grid[i*4+j].val === this.grid[i*4+j+1].val) return true; // Horizontal Check
                        if(this.grid[j*4+i].val === this.grid[(j+1)*4+i].val) return true; // Vertical Check
                    }
                }
                return false;
            },
            
            undo() { 
                if(this.history.length) { 
                    this.grid = JSON.parse(this.history.pop()); 
                    this.render(); 
                } 
            },
            
            gameOver(message) { 
                document.getElementById('over-msg').innerText = message; 
                document.getElementById('over-2048').style.display = 'flex'; 
                clearInterval(this.timer); 
            }
        };

        /* ---------------------------------------------------------
           5. BLOCK PUZZLE ENGINE
           Grid Placement, Matrix Math, Line Clearing, and Drag-and-Drop.
           --------------------------------------------------------- */
        const gameBP = {
            board: Array(64).fill(0), 
            score: 0,
            
            // Expanded Shape Dictionary
            shapes: [
                { m: [[1,1],[1,1]], c: 'bp-filled-green' }, // 2x2 Square
                { m: [[1,1,1,1]], c: 'bp-filled-blue' },    // 4x1 Line
                { m: [[1,1,1],[0,1,0]], c: 'bp-filled-orange' }, // T-Shape
                { m: [[1,0],[1,0],[1,1]], c: 'bp-filled-blue' }, // L-Shape Left
                { m: [[1,1,0],[0,1,1]], c: 'bp-filled-green' }   // Z-Shape
            ],
            
            init() {
                this.board.fill(0); 
                this.score = 0; 
                document.getElementById('over-bp').style.display = 'none';
                
                const g = document.getElementById('bp-grid'); 
                g.innerHTML = '';
                
                for(let i=0; i<64; i++) { 
                    const s = document.createElement('div'); 
                    s.className = 'bp-slot'; 
                    s.id = `bp-c-${i}`; 
                    g.appendChild(s); 
                }
                
                this.spawn();
            },
            
            spawn() {
                const t = document.getElementById('tray'); 
                t.innerHTML = '';
                
                for(let i=0; i<3; i++) {
                    const s = this.shapes[Math.floor(Math.random() * this.shapes.length)];
                    const d = document.createElement('div');
                    
                    d.style.display = 'grid'; 
                    d.style.gridTemplateColumns = `repeat(${s.m[0].length}, 20px)`; 
                    d.style.gap = '2px';
                    
                    s.m.flat().forEach(v => { 
                        const b = document.createElement('div'); 
                        b.style.width = '20px'; 
                        b.style.height = '20px'; 
                        b.style.borderRadius = '2px'; 
                        if(v) b.className = s.c; 
                        d.appendChild(b); 
                    });
                    
                    const startDrag = (e) => this.drag(e.touches ? e.touches[0] : e, d, s.m, s.c);
                    d.onmousedown = startDrag; 
                    d.ontouchstart = startDrag;
                    
                    t.appendChild(d);
                }
            },
            
            drag(pt, el, m, cls) {
                const clone = el.cloneNode(true); 
                clone.className = 'dragging'; 
                
                // Scale the blocks up to 40px to match the board exactly
                clone.style.gridTemplateColumns = `repeat(${m[0].length}, 40px)`;
                Array.from(clone.children).forEach(c => { 
                    c.style.width = '40px'; 
                    c.style.height = '40px'; 
                });
                
                document.body.appendChild(clone);
                
                const move = (e) => {
                    const p = e.touches ? e.touches[0] : e;
                    
                    // Offset by half the shape's width to center on cursor/finger
                    clone.style.left = p.clientX - (m[0].length * 20) + 'px'; 
                    clone.style.top = p.clientY - (m.length * 60) + 'px';
                    
                    document.querySelectorAll('.bp-ghost').forEach(g => g.classList.remove('bp-ghost'));
                    
                    const r = document.getElementById('bp-grid').getBoundingClientRect();
                    const c = Math.round((p.clientX - r.left - (m[0].length * 20)) / 43);
                    const rw = Math.round((p.clientY - r.top - (m.length * 60)) / 43);
                    
                    if(this.canPlace(m, rw, c)) {
                        for(let i=0; i<m.length; i++) {
                            for(let j=0; j<m[0].length; j++) {
                                if(m[i][j]) document.getElementById(`bp-c-${(rw+i)*8+(c+j)}`).classList.add('bp-ghost');
                            }
                        }
                    }
                };
                
                const end = (e) => {
                    const p = e.changedTouches ? e.changedTouches[0] : e;
                    const r = document.getElementById('bp-grid').getBoundingClientRect();
                    
                    const col = Math.round((p.clientX - r.left - (m[0].length * 20)) / 43);
                    const row = Math.round((p.clientY - r.top - (m.length * 60)) / 43);
                    
                    if(this.canPlace(m, row, col)) {
                        // Lock the blocks into the grid
                        for(let i=0; i<m.length; i++) {
                            for(let j=0; j<m[0].length; j++) {
                                if(m[i][j]) { 
                                    this.board[(row+i)*8+(col+j)] = 1; 
                                    document.getElementById(`bp-c-${(row+i)*8+(col+j)}`).className = `bp-slot ${cls}`; 
                                }
                            }
                        }
                        
                        sfx.wood(); 
                        el.style.visibility = 'hidden'; 
                        
                        // Add Base Points
                        this.score += (m.flat().filter(v => v).length * 10);
                        
                        this.clearLines(); 
                        document.getElementById('score-bp').innerText = this.score;
                        
                        // Respawn pieces if the tray is empty
                        if(Array.from(el.parentNode.children).every(c => c.style.visibility === 'hidden')) {
                            this.spawn();
                        }
                    }
                    
                    // Clean up ghosts and clones
                    clone.remove(); 
                    document.querySelectorAll('.bp-ghost').forEach(g => g.classList.remove('bp-ghost'));
                    
                    window.removeEventListener('mousemove', move); 
                    window.removeEventListener('mouseup', end);
                    window.removeEventListener('touchmove', move); 
                    window.removeEventListener('touchend', end);
                };
                
                window.addEventListener('mousemove', move); 
                window.addEventListener('mouseup', end);
                window.addEventListener('touchmove', move, {passive: false}); 
                window.addEventListener('touchend', end);
            },
            
            canPlace(m, r, c) {
                // Check Boundaries
                if(r < 0 || c < 0 || r + m.length > 8 || c + m[0].length > 8) return false;
                
                // Check Collisions
                for(let i=0; i<m.length; i++) {
                    for(let j=0; j<m[0].length; j++) {
                        if(m[i][j] && this.board[(r+i)*8+(c+j)]) return false;
                    }
                }
                return true;
            },
            
            clearLines() {
                let rows = [], cols = [];
                
                // Scan for complete rows and columns
                for(let i=0; i<8; i++) {
                    if(this.board.slice(i*8, i*8+8).every(v => v)) rows.push(i);
                    
                    let c = []; 
                    for(let j=0; j<8; j++) c.push(this.board[j*8+i]);
                    if(c.every(v => v)) cols.push(i);
                }
                
                // Visually clear the arrays and HTML elements
                rows.forEach(r => { 
                    for(let i=0; i<8; i++) { 
                        this.board[r*8+i] = 0; 
                        document.getElementById(`bp-c-${r*8+i}`).className = 'bp-slot'; 
                    } 
                });
                
                cols.forEach(c => { 
                    for(let i=0; i<8; i++) { 
                        this.board[i*8+c] = 0; 
                        document.getElementById(`bp-c-${i*8+c}`).className = 'bp-slot'; 
                    } 
                });
                
                // Score Combos and Achievements
                if(rows.length || cols.length) { 
                    this.score += (rows.length + cols.length) * 100; 
                    sfx.win(); 
                    
                    if(rows.length + cols.length >= 3) {
                        sys.checkAchievement("Tetris Master"); 
                    }
                }
            }
        };

        // Initialize the System on Load
        window.onload = () => sys.init();
        
    </script>
</body>
</html>
