<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>e2048</title>
    <style>
        :root { --bg: #faf8ef; --grid-bg: #bbada0; --tile-empty: #cdc1b4; --text-dark: #776e65; }
        body { background: var(--bg); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; touch-action: none; }
        
        /* Screens */
        .screen { display: none; flex-direction: column; align-items: center; width: 90%; max-width: 400px; transition: opacity 0.3s; }
        .active { display: flex; }

        /* Animations */
        @keyframes pop {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes merge {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .tile { 
            width: 75px; height: 75px; border-radius: 4px; display: flex; 
            justify-content: center; align-items: center; font-size: 24px; 
            font-weight: bold; position: relative; transition: all 0.1s ease-in-out;
        }
        .tile-new { animation: pop 0.2s ease; }
        .tile-merged { animation: merge 0.15s ease; }

        #grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-gap: 8px; background: var(--grid-bg); padding: 8px; border-radius: 6px; width: 320px; height: 320px; }
        button { background: #8f7a66; border: none; border-radius: 5px; color: white; padding: 15px; font-size: 18px; font-weight: bold; margin: 5px; width: 100%; cursor: pointer; }
        #score-box { background: #bbada0; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; width: 100%; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen active">
        <h1>e2048</h1>
        <button onclick="initAudio(); showScreen('mode-screen')">Start Game</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="score-box">Score: <span id="score">0</span></div>
        <div id="grid"></div>
        <button style="margin-top:20px; background:#d33;" onclick="showScreen('menu-screen')">Quit</button>
    </div>

    <script>
        let grid = [];
        let score = 0;
        let lastGrid = [];
        let audioCtx = null;

        // --- SOUND ENGINE ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'move') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            } else if (type === 'merge') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            }
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- GAME LOGIC ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startGame() {
            score = 0;
            grid = Array(16).fill(0);
            addTile(); addTile(); render();
            showScreen('game-screen');
        }

        function addTile() {
            let empty = grid.map((v, i) => v === 0 ? i : null).filter(v => v !== null);
            if (empty.length) {
                let idx = empty[Math.floor(Math.random() * empty.length)];
                grid[idx] = Math.random() > 0.1 ? 2 : 4;
                return idx; // Return for animation tracking
            }
        }

        function render(newIdx = -1, mergedIndices = []) {
            const container = document.getElementById('grid');
            container.innerHTML = '';
            grid.forEach((v, i) => {
                const d = document.createElement('div');
                d.className = 'tile';
                if (i === newIdx) d.classList.add('tile-new');
                if (mergedIndices.includes(i)) d.classList.add('tile-merged');
                
                d.innerText = v || '';
                d.style.background = v ? `hsl(${45 - Math.log2(v)*5}, 80%, 60%)` : 'var(--tile-empty)';
                d.style.color = v > 4 ? 'white' : 'var(--text-dark)';
                container.appendChild(d);
            });
            document.getElementById('score').innerText = score;
        }

        function move(dir) {
            let oldGrid = [...grid];
            let hasMerged = false;
            let mergedThisTurn = [];

            for (let i = 0; i < 4; i++) {
                let line = [];
                for (let j = 0; j < 4; j++) {
                    if (dir === 'L' || dir === 'R') line.push(grid[i * 4 + j]);
                    else line.push(grid[j * 4 + i]);
                }
                if (dir === 'R' || dir === 'D') line.reverse();
                
                // Slide & Merge
                let res = line.filter(v => v);
                for (let j = 0; j < res.length - 1; j++) {
                    if (res[j] === res[j+1]) {
                        res[j] *= 2; score += res[j];
                        res.splice(j+1, 1);
                        hasMerged = true;
                    }
                }
                while (res.length < 4) res.push(0);

                if (dir === 'R' || dir === 'D') res.reverse();
                for (let j = 0; j < 4; j++) {
                    if (dir === 'L' || dir === 'R') grid[i * 4 + j] = res[j];
                    else grid[j * 4 + i] = res[j];
                }
            }

            if (JSON.stringify(oldGrid) !== JSON.stringify(grid)) {
                if (hasMerged) playSound('merge');
                else playSound('move');
                let newIdx = addTile();
                render(newIdx);
            }
        }

        // Swipe Handling
        let tS = {x: 0, y: 0};
        window.addEventListener('touchstart', e => { tS.x = e.touches[0].clientX; tS.y = e.touches[0].clientY; }, {passive: false});
        window.addEventListener('touchend', e => {
            let dx = e.changedTouches[0].clientX - tS.x;
            let dy = e.changedTouches[0].clientY - tS.y;
            if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                if (Math.abs(dx) > Math.abs(dy)) move(dx > 0 ? 'R' : 'L');
                else move(dy > 0 ? 'D' : 'U');
            }
        }, {passive: false});

        startGame();
    </script>
</body>
</html>
