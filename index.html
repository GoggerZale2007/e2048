<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048: Ultimate Edition</title>
    <style>
        :root {
            --bg-main: #faf8ef;
            --text-dark: #776e65;
            --board-bg: #bbada0;
            --cell-empty: rgba(238, 228, 218, 0.35);
            --accent-gold: #edc22e;
            --transition-speed: 150ms;
            
            /* Block Puzzle Theme */
            --bp-bg: #2c3e50;
            --bp-board: #34495e;
            --bp-cell: #2c3e50;
            --bp-accent: #e74c3c;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
            margin: 0; padding: 0;
        }

        body { 
            height: 100vh; width: 100vw; 
            overflow: hidden; 
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif; 
            background: var(--bg-main); 
            color: var(--text-dark); 
            display: flex; justify-content: center; align-items: center;
        }

        /* SCREEN SYSTEM */
        .view { 
            display: none; 
            position: absolute; 
            width: 100%; height: 100%; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            animation: slideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .active-view { display: flex; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* BUTTONS & UI */
        .btn { 
            background: #8f7a66; color: #f9f6f2; 
            border: none; padding: 15px 30px; 
            border-radius: 6px; font-weight: bold; 
            font-size: 18px; cursor: pointer; 
            text-transform: uppercase; margin: 8px; 
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 0 #705f51;
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #705f51; }
        .btn-green { background: #71b965; box-shadow: 0 4px 0 #5a9451; }
        .btn-blue { background: #5da5da; box-shadow: 0 4px 0 #467da5; }

        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .input-field { 
            padding: 16px; border-radius: 8px; 
            border: 3px solid var(--board-bg); 
            width: 300px; font-size: 18px; text-align: center;
            background: rgba(255,255,255,0.9);
        }

        /* 2048 ENGINE STYLES */
        .game-header { width: 360px; display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .score-container { display: flex; gap: 10px; }
        .score-box { 
            background: var(--board-bg); padding: 8px 18px; 
            border-radius: 5px; color: white; text-align: center;
            min-width: 80px; position: relative;
        }
        .score-label { font-size: 12px; font-weight: bold; opacity: 0.8; display: block; }
        .score-val { font-size: 24px; font-weight: bold; }

        .board-2048 { 
            position: relative; width: 360px; height: 360px; 
            background: var(--board-bg); border-radius: 8px; padding: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .grid-bg { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; width: 100%; height: 100%; }
        .cell { background: var(--cell-empty); border-radius: 4px; }

        /* TILE PHYSICS */
        .tile-layer { position: absolute; top: 12px; left: 12px; width: 336px; height: 336px; pointer-events: none; }
        .tile { 
            position: absolute; width: 75px; height: 75px; 
            border-radius: 4px; display: flex; 
            justify-content: center; align-items: center; 
            font-weight: bold; font-size: 32px;
            transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }
        
        /* TILE COLORS */
        .t2 { background: #eee4da; color: #776e65; }
        .t4 { background: #ede0c8; color: #776e65; }
        .t8 { background: #f2b179; color: #f9f6f2; }
        .t16 { background: #f59563; color: #f9f6f2; }
        .t32 { background: #f67c5f; color: #f9f6f2; }
        .t64 { background: #f65e3b; color: #f9f6f2; }
        .t128 { background: #edcf72; color: #f9f6f2; font-size: 28px; box-shadow: 0 0 10px #edcf72; }
        .t256 { background: #edcc61; color: #f9f6f2; font-size: 28px; box-shadow: 0 0 15px #edcc61; }
        .t512 { background: #edc850; color: #f9f6f2; font-size: 28px; }
        .t1024 { background: #edc53f; color: #f9f6f2; font-size: 24px; }
        .t2048 { background: #edc22e; color: #f9f6f2; font-size: 24px; box-shadow: 0 0 25px rgba(243, 156, 18, 0.5); }
        .t-super { background: #3c3a32; color: #f9f6f2; }

        /* ANIMATIONS */
        .t-spawn { animation: spawn 200ms ease-out; }
        .t-merge { z-index: 20; animation: merge 200ms ease-in-out; }
        @keyframes spawn { 0% { opacity: 0; transform: scale(0); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes merge { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .t-dying { opacity: 0; transition: opacity 100ms; }

        /* BLOCK PUZZLE ENGINE */
        .bp-container { background: var(--bp-bg); padding: 40px; border-radius: 20px; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .bp-grid { display: grid; grid-template-columns: repeat(8, 45px); gap: 4px; background: var(--bp-board); padding: 10px; border-radius: 8px; }
        .bp-cell { width: 45px; height: 45px; background: var(--bp-cell); border-radius: 4px; transition: 0.2s; }
        .bp-filled { background: #2ecc71; box-shadow: inset -4px -4px 0 rgba(0,0,0,0.2); transform: scale(0.95); }
        .bp-ghost { background: rgba(255,255,255,0.15); }
        .tray { display: flex; gap: 20px; margin-top: 30px; height: 120px; justify-content: center; align-items: center; }
        .dragging { position: fixed; pointer-events: none; z-index: 1000; opacity: 0.8; transform: scale(1.1); }

        /* OVERLAYS */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(238, 228, 218, 0.73); z-index: 100; 
            display: none; flex-direction: column; align-items: center; 
            justify-content: center; backdrop-filter: blur(4px);
        }

        #toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: #333; color: white; padding: 12px 30px; 
            border-radius: 50px; font-weight: bold; z-index: 2000; 
            transition: opacity 0.3s; opacity: 0; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="toast">Message here</div>

    <div id="view-auth" class="view active-view">
        <h1 style="font-size: 72px; color: var(--board-bg); margin-bottom: 20px;">e2048</h1>
        <div class="input-group">
            <input type="text" id="auth-u" placeholder="Username" class="input-field">
            <input type="password" id="auth-p" placeholder="Password" class="input-field">
        </div>
        <button class="btn btn-green" style="width: 300px;" onclick="app.login()">Login / Play</button>
        <p style="margin-top: 15px; opacity: 0.6; font-size: 14px;">Progress autosaves to local storage</p>
    </div>

    <div id="view-home" class="view">
        <h2 id="welcome-txt" style="font-size: 32px; margin-bottom: 30px;">Welcome Back</h2>
        <button class="btn btn-blue" style="width: 320px;" onclick="app.nav('view-modes')">Play 2048 Modes</button>
        <button class="btn btn-green" style="width: 320px;" onclick="app.nav('view-bp')">Block Puzzle</button>
        <button class="btn" style="width: 320px;" onclick="app.nav('view-stats')">View Highscores</button>
        <button class="btn" style="width: 320px; background:#e74c3c;" onclick="location.reload()">Logout</button>
    </div>

    <div id="view-modes" class="view">
        <h2 style="margin-bottom: 20px;">Choose Your Target</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 340px;">
            <button class="btn" onclick="game2048.start(1024)">1024</button>
            <button class="btn" onclick="game2048.start(2048)">2048</button>
            <button class="btn" onclick="game2048.start(4096)">4096</button>
            <button class="btn" onclick="game2048.start(8192)">8192</button>
            <button class="btn" onclick="game2048.start(16384)">16384</button>
            <button class="btn" onclick="game2048.start(32768)">32768</button>
            <button class="btn" onclick="game2048.start(65536)">65536</button>
            <button class="btn" onclick="game2048.start(131072)">131072</button>
        </div>
        <button class="btn btn-blue" style="width: 340px;" onclick="game2048.start(Infinity)">Endless Mode</button>
        <button class="btn btn-green" style="width: 340px;" onclick="app.nav('view-home')">Main Menu</button>
    </div>

    <div id="view-2048" class="view">
        <div class="game-header">
            <h1 id="mode-title" style="font-size: 40px;">2048</h1>
            <div class="score-container">
                <div class="score-box"><span class="score-label">SCORE</span><span id="cur-score" class="score-val">0</span></div>
                <div class="score-box"><span class="score-label">BEST</span><span id="best-score" class="score-val">0</span></div>
            </div>
        </div>
        <div class="board-2048" id="board-2048">
            <div class="grid-bg">
                <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
                <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
                <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
                <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
            </div>
            <div class="tile-layer" id="tile-layer"></div>
            <div class="overlay" id="overlay-2048">
                <h2 style="font-size: 48px; margin-bottom: 20px;">Game Over</h2>
                <button class="btn" onclick="game2048.start(game2048.target)">Try Again</button>
                <button class="btn btn-green" onclick="app.nav('view-home')">Menu</button>
            </div>
        </div>
        <div style="width: 360px; display: flex; margin-top: 20px;">
            <button class="btn btn-blue" style="flex: 1;" onclick="game2048.undo()">UNDO</button>
            <button class="btn" style="flex: 1;" onclick="game2048.start(game2048.target)">RESET</button>
        </div>
    </div>

    <div id="view-bp" class="view" style="background: var(--bp-bg);">
        <div class="game-header" style="color: white;">
            <h2 style="font-size: 32px;">Score: <span id="bp-score">0</span></h2>
            <button class="btn btn-blue" onclick="app.nav('view-home')">Quit</button>
        </div>
        <div class="bp-container">
            <div class="bp-grid" id="bp-grid"></div>
        </div>
        <div class="tray" id="bp-tray"></div>
        <div class="overlay" id="overlay-bp" style="background: rgba(0,0,0,0.8); color: white;">
            <h1>No More Moves</h1>
            <button class="btn btn-green" onclick="gameBP.init()">Restart</button>
        </div>
    </div>

    <div id="view-stats" class="view">
        <div style="background: white; padding: 40px; border-radius: 15px; width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
            <h2 style="border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Your Records</h2>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Total Points:</span><strong id="stat-total-points">0</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Highest Tile:</span><strong id="stat-high-tile">2</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Merges Done:</span><strong id="stat-total-merges">0</strong>
            </div>
            <div id="achievement-rack" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 20px;"></div>
            <button class="btn btn-blue" style="width: 100%; margin-top: 20px;" onclick="app.nav('view-home')">Back</button>
        </div>
    </div>

    <script>
        /* CORE APPLICATION SYSTEM */
        const app = {
            db: { users: {} },
            curUser: null,
            init() {
                const saved = localStorage.getItem('e2048_master_db');
                if(saved) this.db = JSON.parse(saved);
                this.bindInputs();
            },
            nav(id) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
                document.getElementById(id).classList.add('active-view');
                if(id === 'view-bp') gameBP.init();
                if(id === 'view-stats') this.loadStats();
            },
            toast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2500);
            },
            login() {
                const u = document.getElementById('auth-u').value.trim();
                const p = document.getElementById('auth-p').value.trim();
                if(!u) return alert("Enter Username");
                if(!this.db.users[u]) {
                    this.db.users[u] = { pass: p, best: 0, totalScore: 0, highTile: 2, merges: 0, achievements: [] };
                    this.save();
                    this.toast("Account Created!");
                }
                this.curUser = u;
                document.getElementById('welcome-txt').innerText = `Welcome, ${u}`;
                this.nav('view-home');
            },
            save() { localStorage.setItem('e2048_master_db', JSON.stringify(this.db)); },
            loadStats() {
                const u = this.db.users[this.curUser];
                document.getElementById('stat-total-points').innerText = u.totalScore;
                document.getElementById('stat-high-tile').innerText = u.highTile;
                document.getElementById('stat-total-merges').innerText = u.merges;
                
                const rack = document.getElementById('achievement-rack');
                rack.innerHTML = '';
                u.achievements.forEach(a => {
                    const s = document.createElement('span');
                    s.style = "background: #edc22e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;";
                    s.innerText = a; rack.appendChild(s);
                });
            },
            bindInputs() {
                let startX, startY;
                document.getElementById('board-2048').addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
                }, {passive: true});
                document.getElementById('board-2048').addEventListener('touchend', e => {
                    const dx = e.changedTouches[0].clientX - startX;
                    const dy = e.changedTouches[0].clientY - startY;
                    if(Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                        game2048.move(Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? 'R' : 'L') : (dy > 0 ? 'D' : 'U'));
                    }
                }, {passive: true});
                window.addEventListener('keydown', e => {
                    if(e.key.includes('Arrow')) game2048.move(e.key[5]);
                });
            }
        };

        /* 2048 GAME ENGINE */
        const game2048 = {
            grid: [], score: 0, target: 2048, history: [],
            start(t) {
                this.target = t; this.score = 0; this.grid = Array(16).fill(null);
                document.getElementById('overlay-2048').style.display = 'none';
                document.getElementById('mode-title').innerText = t === Infinity ? "âˆž" : t;
                const best = app.db.users[app.curUser].best || 0;
                document.getElementById('best-score').innerText = best;
                this.spawn(); this.spawn(); this.render();
                app.nav('view-2048');
            },
            spawn() {
                const empty = this.grid.map((v,i) => v === null ? i : null).filter(v => v !== null);
                if(empty.length) {
                    const idx = empty[Math.floor(Math.random() * empty.length)];
                    this.grid[idx] = { val: Math.random() < 0.9 ? 2 : 4, id: Math.random().toString(36).substr(2, 9), isNew: true };
                }
            },
            render() {
                const layer = document.getElementById('tile-layer');
                const activeIds = new Set();
                this.grid.forEach((t, i) => {
                    if(!t) return; activeIds.add(t.id);
                    let el = document.querySelector(`[data-id="${t.id}"]`);
                    if(!el) {
                        el = document.createElement('div');
                        el.dataset.id = t.id; layer.appendChild(el);
                    }
                    const x = (i % 4) * 87; const y = Math.floor(i / 4) * 87;
                    el.className = `tile t${t.val > 2048 ? '2048' : t.val} ${t.isNew ? 't-spawn' : ''} ${t.merged ? 't-merge' : ''}`;
                    el.style.transform = `translate(${x}px, ${y}px)`;
                    el.innerText = t.val;
                    t.isNew = false; t.merged = false;
                });
                layer.querySelectorAll('.tile').forEach(el => {
                    if(!activeIds.has(el.dataset.id)) {
                        el.classList.add('t-dying');
                        setTimeout(() => el.remove(), 100);
                    }
                });
                document.getElementById('cur-score').innerText = this.score;
            },
            move(dir) {
                let moved = false;
                this.history.push(JSON.stringify(this.grid));
                if(this.history.length > 10) this.history.shift();

                const rotate = (times) => {
                    for(let t=0; t<times; t++) {
                        let next = Array(16).fill(null);
                        for(let r=0; r<4; r++) for(let c=0; c<4; c++) next[c*4 + (3-r)] = this.grid[r*4 + c];
                        this.grid = next;
                    }
                };

                const rotMap = { 'U': 0, 'R': 1, 'D': 2, 'L': 3 };
                const r = rotMap[dir];
                rotate(r);

                // Slide & Merge Logic
                for(let c=0; c<4; c++) {
                    let col = [this.grid[c], this.grid[c+4], this.grid[c+8], this.grid[c+12]].filter(v => v);
                    for(let i=0; i<col.length-1; i++) {
                        if(col[i].val === col[i+1].val) {
                            col[i].val *= 2; 
                            this.score += col[i].val;
                            col[i].merged = true;
                            col.splice(i+1, 1);
                            moved = true;
                            app.db.users[app.curUser].merges++;
                            if(col[i].val > app.db.users[app.curUser].highTile) app.db.users[app.curUser].highTile = col[i].val;
                        }
                    }
                    while(col.length < 4) col.push(null);
                    [this.grid[c], this.grid[c+4], this.grid[c+8], this.grid[c+12]] = col;
                }

                rotate((4-r) % 4);
                
                // Final Check
                if(moved || JSON.stringify(JSON.parse(this.history[this.history.length-1])) !== JSON.stringify(this.grid)) {
                    this.spawn(); this.render();
                    if(this.score > app.db.users[app.curUser].best) app.db.users[app.curUser].best = this.score;
                    app.db.users[app.curUser].totalScore += this.score;
                    app.save();
                    if(!this.canMove()) document.getElementById('overlay-2048').style.display = 'flex';
                }
            },
            canMove() {
                if(this.grid.includes(null)) return true;
                for(let i=0; i<16; i++) {
                    const v = this.grid[i].val;
                    if(i % 4 < 3 && this.grid[i+1] && this.grid[i+1].val === v) return true;
                    if(i < 12 && this.grid[i+4] && this.grid[i+4].val === v) return true;
                }
                return false;
            },
            undo() {
                if(this.history.length) {
                    this.grid = JSON.parse(this.history.pop());
                    this.render();
                }
            }
        };

        /* BLOCK PUZZLE ENGINE */
        const gameBP = {
            board: Array(64).fill(0), score: 0,
            shapes: [
                {m:[[1,1],[1,1]]}, {m:[[1,1,1,1]]}, {m:[[1,1,1],[0,1,0]]}, {m:[[1,0],[1,1]]}, {m:[[1]]}
            ],
            init() {
                this.score = 0; this.board.fill(0);
                document.getElementById('overlay-bp').style.display = 'none';
                const g = document.getElementById('bp-grid'); g.innerHTML = '';
                for(let i=0; i<64; i++) {
                    const d = document.createElement('div'); d.className = 'bp-cell'; d.id = `bp-${i}`; g.appendChild(d);
                }
                this.spawn();
            },
            spawn() {
                const tray = document.getElementById('bp-tray'); tray.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const s = this.shapes[Math.floor(Math.random()*this.shapes.length)];
                    const d = document.createElement('div'); d.style.display = 'grid';
                    d.style.gridTemplateColumns = `repeat(${s.m[0].length}, 25px)`;
                    s.m.flat().forEach(v => {
                        const b = document.createElement('div');
                        b.style = `width:25px; height:25px; border-radius:2px; ${v?'background:#2ecc71;':''}`;
                        d.appendChild(b);
                    });
                    d.onmousedown = (e) => this.drag(e, d, s.m);
                    d.ontouchstart = (e) => this.drag(e.touches[0], d, s.m);
                    tray.appendChild(d);
                }
            },
            drag(p, el, m) {
                const clone = el.cloneNode(true); clone.className = 'dragging';
                clone.style.gridTemplateColumns = `repeat(${m[0].length}, 45px)`;
                Array.from(clone.children).forEach(c => { c.style.width = '45px'; c.style.height = '45px'; });
                document.body.appendChild(clone);
                
                const move = (e) => {
                    const pos = e.touches ? e.touches[0] : e;
                    clone.style.left = pos.clientX - 60 + 'px'; clone.style.top = pos.clientY - 60 + 'px';
                };
                const end = (e) => {
                    const pos = e.changedTouches ? e.changedTouches[0] : e;
                    const rect = document.getElementById('bp-grid').getBoundingClientRect();
                    const col = Math.floor((pos.clientX - rect.left) / 49);
                    const row = Math.floor((pos.clientY - rect.top) / 49);
                    
                    if(this.canPlace(m, row, col)) {
                        m.forEach((r, ri) => r.forEach((v, ci) => {
                            if(v) {
                                const idx = (row+ri)*8 + (col+ci);
                                this.board[idx] = 1;
                                document.getElementById(`bp-${idx}`).classList.add('bp-filled');
                            }
                        }));
                        el.style.visibility = 'hidden';
                        this.checkLines();
                        if(Array.from(el.parentNode.children).every(c => c.style.visibility === 'hidden')) this.spawn();
                    }
                    clone.remove();
                    window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', end);
                };
                window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
                window.addEventListener('touchmove', move); window.addEventListener('touchend', end);
            },
            canPlace(m, r, c) {
                if(r < 0 || c < 0 || r + m.length > 8 || c + m[0].length > 8) return false;
                return m.every((row, ri) => row.every((v, ci) => !v || !this.board[(r+ri)*8 + (c+ci)]));
            },
            checkLines() {
                let rows = [], cols = [];
                for(let i=0; i<8; i++) {
                    if(this.board.slice(i*8, i*8+8).every(v => v)) rows.push(i);
                    let col = []; for(let j=0; j<8; j++) col.push(this.board[j*8 + i]);
                    if(col.every(v => v)) cols.push(i);
                }
                rows.forEach(r => { for(let i=0; i<8; i++) this.board[r*8+i] = 0; });
                cols.forEach(c => { for(let i=0; i<8; i++) this.board[i*8+c] = 0; });
                this.score += (rows.length + cols.length) * 100;
                document.getElementById('bp-score').innerText = this.score;
                setTimeout(() => {
                    for(let i=0; i<64; i++) {
                        document.getElementById(`bp-${i}`).className = `bp-cell ${this.board[i]?'bp-filled':''}`;
                    }
                }, 200);
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
