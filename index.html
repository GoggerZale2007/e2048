<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048</title>
    <style>
        :root {
            --bg-2048: #faf8ef; --text-2048: #776e65; --board-2048: #bbada0; 
            --cell-2048: rgba(238, 228, 218, 0.35); --score-bg: #bbada0;
            --bp-bg: #a0745b; --bp-board: #674332; --bp-cell: #573727; 
            --bp-green: #71b965; --bp-beige: #dac6a3;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: "Clear Sans", Arial, sans-serif; background: var(--bg-2048); color: var(--text-2048); transition: background 0.3s; }
        
        .view { display: none; position: absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; align-items:center; background:inherit; z-index:10; overflow-y:auto; padding:20px 0; }
        .active-view { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .btn { background:#8f7a66; color:#f9f6f2; border:none; padding:12px 24px; border-radius:3px; font-weight:bold; font-size:16px; cursor:pointer; text-transform:uppercase; margin:5px; box-shadow:0 4px 0 rgba(0,0,0,0.1); }
        .btn:active { transform:translateY(2px); box-shadow:none; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; box-shadow: none; transform: none; opacity: 0.6; }
        
        .input-field { padding:14px; border-radius:5px; border:2px solid #bbada0; width:280px; font-size:16px; margin-bottom:12px; }
        
        .top-header { width:340px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .score-container { display:flex; gap:8px; }
        .score-box { background:#bbada0; padding:5px 15px; border-radius:3px; color:white; text-align:center; min-width:60px; position:relative; }
        .score-label { display:block; font-size:11px; font-weight:bold; color:#eee4da; margin-bottom:-2px; }
        .score-val { font-size:20px; font-weight:bold; }
        
        .game-wrapper { position:relative; width:340px; height:340px; background:var(--board-2048); border-radius:6px; padding:10px; touch-action:none; }
        .grid-bg { display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; width:100%; height:100%; }
        .grid-cell { background:var(--cell-2048); border-radius:3px; }
        .tile-layer { position:absolute; top:10px; left:10px; pointer-events:none; width:320px; height:320px; }
        
        .tile { position:absolute; width:72.5px; height:72.5px; border-radius:3px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:32px; transition:transform 100ms ease-in-out; z-index:10; pointer-events:auto; }
        .t-new { animation: appear 150ms ease-out forwards; }
        .t-merged { z-index:20; animation: pop 180ms ease-in-out forwards; }
        @keyframes appear { 0% { opacity:0; scale:0; } 100% { opacity:1; scale:1; } }
        @keyframes pop { 0% { scale:1; } 50% { scale:1.15; } 100% { scale:1; } }
        
        .t2{background:#eee4da;color:#776e65} .t4{background:#ede0c8;color:#776e65} .t8{background:#f2b179;color:#f9f6f2} .t16{background:#f59563;color:#f9f6f2} .t32{background:#f67c5f;color:#f9f6f2} .t64{background:#f65e3b;color:#f9f6f2} .t128{background:#edcf72;color:#f9f6f2;font-size:28px} .t256{background:#edcc61;color:#f9f6f2;font-size:28px} .t512{background:#edc850;color:#f9f6f2;font-size:28px} .t1024{background:#edc53f;color:#f9f6f2;font-size:24px} .t2048{background:#edc22e;color:#f9f6f2;font-size:24px}

        .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(250,248,239,0.95); z-index:100; display:none; flex-direction:column; align-items:center; justify-content:center; text-align: center; padding: 20px; }
        #toast { position:fixed; top:-100px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:12px 24px; border-radius:30px; transition:0.4s; z-index:9999; font-weight:bold; }
        
        /* Owner UI */
        #owner-login-btn { position: fixed; top: 10px; right: 10px; z-index: 1000; font-size: 10px; padding: 5px 10px; opacity: 0.6; }
        .owner-ctrl-panel { background: #333; color: white; padding: 20px; border-radius: 10px; width: 320px; margin-top: 20px; }
        .owner-ctrl-panel h3 { margin-top: 0; color: #ffcc00; }
        .difficulty-indicator { font-weight: bold; padding: 5px; border-radius: 4px; display: inline-block; margin-bottom: 10px; }
        .diff-1 { background: #4CAF50; } .diff-2 { background: #FFC107; } .diff-3 { background: #F44336; } .diff-4 { background: #000; color: #ff0000; }
    </style>
</head>
<body>
    <div id="toast">Notification</div>
    <button id="owner-login-btn" class="btn" onclick="owner.promptLogin()">Login as Owner</button>

    <div id="global-stop-overlay" class="overlay" style="z-index: 99999; position: fixed;">
        <h1 style="font-size: 40px;">‚ö†Ô∏è</h1>
        <h2 style="color:#776e65;">e2048 was stopped by the owner</h2>
        <p>Please wait until e2048 starts again.</p>
        <button class="btn" onclick="document.getElementById('global-stop-overlay').style.display='none'">I understand</button>
    </div>

    <div id="view-auth" class="view active-view" style="justify-content:center;">
        <h1 style="font-size:80px; margin:0 0 40px 0;">e2048</h1>
        <div style="background:rgba(0,0,0,0.05); padding:30px; border-radius:12px; display:flex; flex-direction:column; align-items:center;">
            <input type="text" id="reg-u" placeholder="Username" class="input-field" autocomplete="off">
            <input type="password" id="reg-p" placeholder="Password" class="input-field">
            <div style="display:flex; flex-direction:column; width:100%;">
                <button class="btn" onclick="auth.login()">Login</button>
                <button class="btn" style="background:#71b965" onclick="auth.register()">Create Account</button>
            </div>
            <button class="btn" style="background:transparent; color:#776e65; box-shadow:none; margin-top:10px;" onclick="auth.guest()">Play as Guest</button>
        </div>
    </div>

    <div id="view-owner" class="view">
        <h1>Owner Control</h1>
        <div class="owner-ctrl-panel">
            <h3>System Status</h3>
            <button id="owner-stop-btn" class="btn" style="width:100%;" onclick="owner.toggleSystem()">Stop System</button>
            <hr>
            <h3>Difficulty</h3>
            <div id="diff-label" class="difficulty-indicator diff-1">Level: Normal</div><br>
            <button class="btn" onclick="owner.setDifficulty()">Change Difficulty</button>
            <hr>
            <h3>Mode Locking</h3>
            <p style="font-size: 12px;">Tap a mode below to toggle lock:</p>
            <div id="owner-mode-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;"></div>
        </div>
        <button class="btn btn-red" style="margin-top: 20px; background: #555;" onclick="sys.nav('view-home')">Exit Admin</button>
    </div>

    <div id="view-home" class="view">
        <h2 id="welcome-msg" style="font-size:32px; margin-bottom:40px;">Welcome back</h2>
        <button id="admin-access-btn" class="btn" style="width:260px; display:none; background:#ffcc00; color:#000;" onclick="sys.nav('view-owner')">Owner Panel</button>
        <button class="btn" style="width:260px;" onclick="sys.nav('view-modes')">2048 Standard</button>
        <button class="btn" style="width:260px; background:#674332" onclick="sys.nav('view-bp')">Block Puzzle</button>
        <button class="btn" style="width:260px; background:#555" onclick="sys.nav('view-stats')">Player Profile</button>
        <button class="btn" style="width:260px; background:#d33; margin-top:40px;" onclick="auth.logout()">Logout</button>
    </div>

    <div id="view-modes" class="view">
        <div class="top-header"><button class="btn" style="padding:5px 15px;" onclick="sys.nav('view-home')">Back</button><h1 style="font-size:24px; margin:0;">Modes</h1><div style="width:50px;"></div></div>
        <div id="modes-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:20px;">
            <button class="btn mode-btn" data-mode="1024" onclick="game2048.init(1024)">1024</button>
            <button class="btn mode-btn" data-mode="2048" onclick="game2048.init(2048)">2048</button>
            <button class="btn mode-btn" data-mode="4096" onclick="game2048.init(4096)">4096</button>
            <button class="btn mode-btn" data-mode="8192" onclick="game2048.init(8192)">8192</button>
            <button class="btn mode-btn" data-mode="16384" onclick="game2048.init(16384)">16384</button>
            <button class="btn mode-btn" data-mode="32768" onclick="game2048.init(32768)">32768</button>
            <button class="btn mode-btn" data-mode="65536" onclick="game2048.init(65536)">65536</button>
            <button class="btn mode-btn" data-mode="131072" onclick="game2048.init(131072)">131072</button>
        </div>
        <button class="btn mode-btn" data-mode="Blitz" style="width:320px; background:#f65e3b;" onclick="game2048.init(Infinity, 60)">1 Min Blitz</button>
        <button class="btn mode-btn" data-mode="Endless" style="width:320px; background:#333;" onclick="game2048.init(Infinity)">Endless</button>
    </div>

    <div id="view-2048" class="view">
        <div class="top-header">
            <h1 class="title-2048" id="display-target">2048</h1>
            <div class="score-container">
                <div class="score-box"><span class="score-label">SCORE</span><span class="score-val" id="score-2048">0</span></div>
                <div class="score-box"><span class="score-label">BEST</span><span class="score-val" id="best-2048">0</span></div>
            </div>
        </div>
        <div class="game-wrapper" id="board-2048">
            <div class="grid-bg">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
            <div class="tile-layer" id="tile-layer"></div>
            <div class="overlay" id="over-2048">
                <h2 id="over-msg" style="color:#776e65; font-size:36px; margin-bottom:20px;">Game Over!</h2>
                <button class="btn" onclick="game2048.init(game2048.target, game2048.initTime)">Try Again</button>
                <button class="btn" style="background:#555" onclick="sys.nav('view-modes')">Menu</button>
            </div>
        </div>
        <div style="display:flex; gap:15px; margin-top:20px;">
            <button class="btn" style="width:80px; background:#bbada0" onclick="game2048.undo()">‚Ü©</button>
        </div>
    </div>

    <div id="view-bp" class="view" style="background:var(--bp-bg)">
        <div class="top-header"><div style="color:#ffcc00; font-weight:bold; font-size:20px;">üëë <span id="best-bp">0</span></div><button class="btn" style="background:none; box-shadow:none; font-size:24px;" onclick="sys.nav('view-home')">‚úï</button></div>
        <div class="bp-score-large" id="score-bp">0</div>
        <div class="bp-grid-wrapper"><div class="bp-grid" id="bp-grid"></div></div>
        <div id="tray" class="tray"></div>
        <div class="overlay" id="over-bp">
            <h2 style="color:white;">No Moves</h2>
            <button class="btn" onclick="gameBP.init()">Retry</button>
        </div>
    </div>

    <div id="view-stats" class="view">
        <h1>Stats</h1>
        <div id="achievements-list"></div>
        <button class="btn" onclick="sys.nav('view-home')">Back</button>
    </div>

    <script>
        /* --- OWNER CONTROLS --- */
        const owner = {
            isAdmin: false,
            settings: {
                isStopped: false,
                difficulty: 1, // 1:Easy, 2:Normal, 3:Hard, 4:Impossible
                lockedModes: []
            },
            promptLogin() {
                const pass = prompt("Enter Owner Password:");
                if (pass === "luan2022") {
                    this.isAdmin = true;
                    document.getElementById('admin-access-btn').style.display = 'block';
                    document.getElementById('owner-login-btn').style.display = 'none';
                    sys.toast("Welcome, Owner");
                    this.updatePanel();
                } else if (pass !== null) {
                    alert("Incorrect Password.");
                }
            },
            toggleSystem() {
                this.settings.isStopped = !this.settings.isStopped;
                this.save();
                this.updatePanel();
            },
            setDifficulty() {
                this.settings.difficulty = (this.settings.difficulty % 4) + 1;
                this.save();
                this.updatePanel();
            },
            toggleLock(mode) {
                if (this.settings.lockedModes.includes(mode)) {
                    this.settings.lockedModes = this.settings.lockedModes.filter(m => m !== mode);
                } else {
                    this.settings.lockedModes.push(mode);
                }
                this.save();
                this.updatePanel();
            },
            save() { 
                localStorage.setItem('e2048_owner_settings', JSON.stringify(this.settings));
                this.applyState();
            },
            load() {
                const saved = localStorage.getItem('e2048_owner_settings');
                if (saved) this.settings = JSON.parse(saved);
                this.applyState();
            },
            applyState() {
                // Handle Stop
                if (this.settings.isStopped && !this.isAdmin) {
                    document.getElementById('global-stop-overlay').style.display = 'flex';
                } else {
                    document.getElementById('global-stop-overlay').style.display = 'none';
                }

                // Handle Mode Locks
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    const mode = btn.dataset.mode;
                    if (this.settings.lockedModes.includes(mode)) {
                        btn.disabled = true;
                    } else {
                        btn.disabled = false;
                    }
                });
            },
            updatePanel() {
                const stopBtn = document.getElementById('owner-stop-btn');
                stopBtn.innerText = this.settings.isStopped ? "START SYSTEM" : "STOP SYSTEM";
                stopBtn.style.background = this.settings.isStopped ? "#4CAF50" : "#F44336";

                const diffLabel = document.getElementById('diff-label');
                const labels = ["", "Easy", "Normal", "Hard", "Impossible"];
                diffLabel.innerText = "Level: " + labels[this.settings.difficulty];
                diffLabel.className = `difficulty-indicator diff-${this.settings.difficulty}`;

                // Update lock list in panel
                const list = document.getElementById('owner-mode-list');
                list.innerHTML = '';
                const allModes = ["1024", "2048", "4096", "8192", "16384", "32768", "65536", "131072", "Blitz", "Endless"];
                allModes.forEach(m => {
                    const b = document.createElement('button');
                    b.className = 'btn';
                    b.style.fontSize = '10px';
                    b.style.background = this.settings.lockedModes.includes(m) ? "#F44336" : "#8f7a66";
                    b.innerText = (this.settings.lockedModes.includes(m) ? "üîì " : "üîí ") + m;
                    b.onclick = () => this.toggleLock(m);
                    list.appendChild(b);
                });
                this.applyState();
            }
        };

        const sys = {
            db: { users: {} }, user: null, soundOn: true,
            init() {
                try { const saved = localStorage.getItem('e2048_plat_db'); if (saved) this.db = JSON.parse(saved); } catch(e) {}
                owner.load();
                this.bindEvents();
            },
            nav(id) {
                if (owner.settings.isStopped && !owner.isAdmin && id !== 'view-auth') {
                    document.getElementById('global-stop-overlay').style.display = 'flex';
                    return;
                }
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
                document.getElementById(id).classList.add('active-view');
                if (id === 'view-bp') gameBP.init();
            },
            toast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.top = "20px"; setTimeout(() => t.style.top = "-100px", 2500); },
            bindEvents() {
                window.addEventListener('keydown', e => { if(document.getElementById('view-2048').classList.contains('active-view') && e.key.includes('Arrow')) game2048.move(e.key[5][0]); });
                let tx, ty; const b = document.getElementById('board-2048');
                b.addEventListener('touchstart', e => { tx = e.touches[0].clientX; ty = e.touches[0].clientY; });
                b.addEventListener('touchend', e => {
                    let dx = e.changedTouches[0].clientX - tx, dy = e.changedTouches[0].clientY - ty;
                    if(Math.abs(dx)>30 || Math.abs(dy)>30) game2048.move(Math.abs(dx)>Math.abs(dy) ? (dx>0?'R':'L') : (dy>0?'D':'U'));
                });
            }
        };

        const auth = {
            guest() { this.complete('Guest'); },
            register() { const u = document.getElementById('reg-u').value; this.complete(u || 'User'); },
            login() { const u = document.getElementById('reg-u').value; this.complete(u || 'User'); },
            complete(u) { sys.user = u; document.getElementById('welcome-msg').innerText = "Hi, " + u; sys.nav('view-home'); },
            logout() { location.reload(); }
        };

        const game2048 = {
            grid: [], score: 0, history: [], idCounter: 0,
            init(t, sec = 0) {
                this.grid = Array(16).fill(null); this.score = 0;
                document.getElementById('over-2048').style.display = 'none';
                this.spawn(); this.spawn(); this.render(); sys.nav('view-2048');
            },
            spawn() {
                const empty = this.grid.map((v, i) => v === null ? i : null).filter(v => v !== null);
                if (!empty.length) return;
                
                // DIFFICULTY LOGIC
                let val = 2;
                const d = owner.settings.difficulty;
                if (d === 1) val = Math.random() < 0.75 ? 2 : 4; // Easy: more 4s
                else if (d === 2) val = Math.random() < 0.9 ? 2 : 4; // Normal
                else if (d === 3) val = Math.random() < 0.95 ? 2 : 4; // Hard: fewer 4s
                else if (d === 4) val = Math.random() < 0.98 ? (Math.random() < 0.05 ? 1 : 2) : 4; // Impossible: spawns 1s!

                this.grid[empty[Math.floor(Math.random() * empty.length)]] = { id: this.idCounter++, val: val, isNew: true };
            },
            render() {
                const layer = document.getElementById('tile-layer');
                layer.innerHTML = '';
                this.grid.forEach((t, i) => {
                    if (!t) return;
                    const n = document.createElement('div');
                    n.className = `tile t${t.val} ${t.isNew ? 't-new' : ''}`;
                    n.style.transform = `translate(${(i % 4) * 82.5}px, ${Math.floor(i / 4) * 82.5}px)`;
                    n.innerText = t.val;
                    layer.appendChild(n);
                    t.isNew = false;
                });
                document.getElementById('score-2048').innerText = this.score;
            },
            move(dir) {
                let moved = false;
                // Simplified move logic for demo
                this.spawn(); this.render();
            },
            undo() { sys.toast("Undo not available in this build"); }
        };

        const gameBP = { init() { sys.nav('view-bp'); } };

        window.onload = () => sys.init();
    </script>
</body>
</html>
