<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048</title>
    <style>
        :root {
            --bg-2048: #faf8ef; --text-2048: #776e65; --board-2048: #bbada0; 
            --cell-2048: rgba(238, 228, 218, 0.35); --score-bg: #bbada0;
            --bp-bg: #a0745b; --bp-board: #674332; --bp-cell: #573727; 
            --bp-green: #71b965; --bp-beige: #dac6a3;
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            user-select: none; 
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
            font-family: "Clear Sans", Arial, sans-serif; 
            background: var(--bg-2048); 
            color: var(--text-2048); 
            transition: background 0.3s; 
        }
        
        .view { 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            flex-direction: column; 
            align-items: center; 
            background: inherit; 
            z-index: 10; 
            overflow-y: auto; 
            padding: 20px 0; 
        }
        
        .active-view { 
            display: flex; 
            animation: fadeIn 0.3s ease-out; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        .btn { 
            background: #8f7a66; 
            color: #f9f6f2; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 3px; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer; 
            text-transform: uppercase; 
            margin: 5px; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); 
            width: 280px; 
        }
        
        .btn:active { 
            transform: translateY(2px); 
            box-shadow: none; 
        }
        
        .btn:disabled { 
            background: #ccc !important; 
            color: #999 !important; 
            cursor: not-allowed; 
            box-shadow: none; 
            pointer-events: none; 
        }
        
        .input-field { 
            padding: 14px; 
            border-radius: 5px; 
            border: 2px solid #bbada0; 
            width: 280px; 
            font-size: 16px; 
            margin-bottom: 12px; 
        }
        
        .top-header { 
            width: 340px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        
        .score-container { 
            display: flex; 
            gap: 8px; 
        }
        
        .score-box { 
            background: #bbada0; 
            padding: 5px 15px; 
            border-radius: 3px; 
            color: white; 
            text-align: center; 
            min-width: 60px; 
            position: relative; 
        }
        
        .score-label { 
            display: block; 
            font-size: 11px; 
            font-weight: bold; 
            color: #eee4da; 
            margin-bottom: -2px; 
        }
        
        .score-val { 
            font-size: 20px; 
            font-weight: bold; 
        }
        
        .game-wrapper { 
            position: relative; 
            width: 340px; 
            height: 340px; 
            background: var(--board-2048); 
            border-radius: 6px; 
            padding: 10px; 
            touch-action: none; 
        }
        
        .grid-bg { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            width: 100%; 
            height: 100%; 
        }
        
        .grid-cell { 
            background: var(--cell-2048); 
            border-radius: 3px; 
        }
        
        .tile-layer { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            pointer-events: none; 
            width: 320px; 
            height: 320px; 
        }
        
        .tile { 
            position: absolute; 
            width: 72.5px; 
            height: 72.5px; 
            border-radius: 3px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
            font-size: 32px; 
            transition: transform 100ms ease-in-out; 
            z-index: 10; 
            pointer-events: auto; 
        }
        
        .t-new { animation: appear 150ms ease-out forwards; }
        .t-merged { z-index: 20; animation: pop 180ms ease-in-out forwards; }
        
        @keyframes appear { 
            0% { opacity: 0; transform: scale(0); } 
            100% { opacity: 1; transform: scale(1); } 
        }
        
        @keyframes pop { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.15); } 
            100% { transform: scale(1); } 
        }
        
        /* FULL TILESET CSS */
        .t2 { background: #eee4da; color: #776e65; } 
        .t4 { background: #ede0c8; color: #776e65; } 
        .t8 { background: #f2b179; color: #f9f6f2; } 
        .t16 { background: #f59563; color: #f9f6f2; } 
        .t32 { background: #f67c5f; color: #f9f6f2; } 
        .t64 { background: #f65e3b; color: #f9f6f2; } 
        .t128 { background: #edcf72; color: #f9f6f2; font-size: 28px; } 
        .t256 { background: #edcc61; color: #f9f6f2; font-size: 28px; } 
        .t512 { background: #edc850; color: #f9f6f2; font-size: 28px; } 
        .t1024 { background: #edc53f; color: #f9f6f2; font-size: 24px; } 
        .t2048 { background: #edc22e; color: #f9f6f2; font-size: 24px; } 
        .t4096 { background: #3c3a32; color: #f9f6f2; } 
        .t8192 { background: #3c3a32; color: #f9f6f2; } 
        .t16384 { background: #3c3a32; color: #f9f6f2; } 
        .t32768 { background: #3c3a32; color: #f9f6f2; } 
        .t65536 { background: #3c3a32; color: #f9f6f2; } 
        .t131072 { background: #000; color: #00f2ff; text-shadow: 0 0 8px #00f2ff; box-shadow: 0 0 15px #00f2ff; }

        .bp-score-large { font-size: 70px; font-weight: bold; color: white; margin-top: 10px; letter-spacing: -2px; }
        .bp-grid-wrapper { background: var(--bp-board); padding: 8px; border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); touch-action: none; }
        .bp-grid { display: grid; grid-template-columns: repeat(8, 40px); gap: 2px; }
        .bp-slot { width: 40px; height: 40px; background: var(--bp-cell); border-radius: 2px; }
        .bp-filled-green { background: var(--bp-green); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.3), inset -3px -3px 0 rgba(0,0,0,0.2); }
        .bp-filled-beige { background: var(--bp-beige); box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), inset -3px -3px 0 rgba(0,0,0,0.1); }
        .bp-ghost { background: rgba(255,255,255,0.2); }
        
        .tray { display: flex; justify-content: space-around; width: 360px; height: 120px; margin-top: 30px; }
        .shape { display: grid; gap: 2px; cursor: grab; padding: 10px; }
        .mini-block { width: 20px; height: 20px; border-radius: 2px; }
        .dragging { position: fixed; z-index: 1000; pointer-events: none; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(250,248,239,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; transition: 0.4s; z-index: 9999; font-weight: bold; }
        #global-announcement { position: fixed; top: 0; left: 0; width: 100%; background: #ffcc00; color: #333; padding: 10px; font-weight: bold; text-align: center; z-index: 5000; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="toast">Notification</div>
    <div id="global-announcement"></div>

    <div style="position:fixed; top:40px; right:10px; z-index:2000; display:flex; flex-direction:column; gap:5px;">
        <button id="owner-login-btn" class="btn" style="width:115px; font-size:10px; padding:6px; opacity:0.6;" onclick="owner.promptLogin()">Owner Login</button>
        <button id="admin-login-btn" class="btn" style="width:115px; font-size:10px; padding:6px; opacity:0.6; background:#444;" onclick="adminS.promptLogin()">Admin Login</button>
    </div>

    <div id="stop-overlay" class="overlay" style="z-index: 10000; background: #faf8ef;">
        <h1 style="font-size: 60px;">ðŸ›‘</h1>
        <h2 style="color:#776e65;">e2048: Maintenance</h2>
        <p id="stop-timer-display" style="font-weight: bold; color: #d33; font-size: 18px;"></p>
    </div>

    <div id="view-auth" class="view active-view" style="justify-content:center;">
        <h1 style="font-size:80px; margin:0 0 40px 0; color:#776e65;">e2048</h1>
        <input type="text" id="auth-u" placeholder="Username" class="input-field">
        <input type="password" id="auth-p" placeholder="Password" class="input-field">
        <button class="btn" onclick="authS.login()">Login</button>
        <button class="btn" style="background:#71b965" onclick="authS.register()">Register</button>
        <button class="btn" style="background:transparent; color:#776e65; box-shadow:none;" onclick="authS.guest()">Play as Guest</button>
    </div>

    <div id="view-home" class="view">
        <h1 style="font-size:40px; margin-bottom:10px;">e2048</h1>
        <h2 id="welcome-msg" style="margin-bottom:30px; font-size:18px;">Welcome</h2>

        <div id="admin-panel" style="display:none; background:white; padding:15px; border-radius:8px; width:300px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border: 2px solid #444;">
            <p style="margin:0 0 10px 0; font-weight:bold;">DISCORD ANNOUNCEMENT</p>
            <input type="text" id="admin-msg" placeholder="Broadcast to players..." class="input-field" style="width:100%; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
                <button class="btn" style="width:100%; padding:10px; font-size:12px;" onclick="adminS.send()">Send</button>
                <button class="btn" style="width:100%; padding:10px; font-size:12px; background:#777;" onclick="adminS.clear()">Clear</button>
            </div>
        </div>

        <button id="owner-link" class="btn" style="display:none; background:#ffcc00; color:black;" onclick="sys.nav('view-owner')">Owner Control Panel</button>
        <button class="btn" onclick="sys.nav('view-modes')">Play 2048</button>
        <button class="btn" style="background:#674332" onclick="sys.nav('view-bp')">Block Puzzle</button>
        <button class="btn" style="background:#d33; margin-top:30px;" onclick="authS.logout()">Logout</button>
    </div>

    <div id="view-owner" class="view">
        <h1>Owner Settings</h1>
        <div style="background:white; padding:15px; border-radius:8px; width:340px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:10px;">
            <p style="font-weight:bold; margin:0;">1. Maintenance Toggle</p>
            <button id="maint-btn" class="btn" style="width:100%;" onclick="owner.toggleMaint()">ENABLE MAINTENANCE</button>
            <hr style="width:100%;">
            <p style="font-weight:bold; margin:0;">2. Stop Timer</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <input type="number" id="stop-val" placeholder="Value" style="padding:8px;">
                <select id="stop-unit" style="padding:8px;">
                    <option value="60000">Minutes</option>
                    <option value="3600000">Hours</option>
                </select>
            </div>
            <button id="stop-btn" class="btn" style="width:100%; margin-top:10px;" onclick="owner.toggleStop()">Apply Stop</button>
            <hr style="width:100%;">
            <button class="btn" style="background:#8f7a66; width:100%;" onclick="owner.cycleDiff()">Difficulty: <span id="owner-diff-text">Normal</span></button>
            
            <p style="margin:0; font-weight:bold; font-size:14px; margin-top:10px;">3. Mode Locks:</p>
            <div id="owner-lock-controls" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div>
        </div>
        <button class="btn" style="background:#555; margin-top:20px;" onclick="sys.nav('view-home')">Back</button>
    </div>

    <div id="view-modes" class="view">
        <div class="top-header">
            <button class="btn" style="padding:5px 15px; width:90px;" onclick="sys.nav('view-home')">Back</button>
            <h1 style="font-size:24px; margin:0;">Modes</h1>
            <div style="width:90px;"></div>
        </div>
        <div id="modes-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:20px;">
            <button class="btn mode-btn" data-mode="1024" onclick="game2048.init(1024)">1024</button>
            <button class="btn mode-btn" data-mode="2048" onclick="game2048.init(2048)">2048</button>
            <button class="btn mode-btn" data-mode="4096" onclick="game2048.init(4096)">4096</button>
            <button class="btn mode-btn" data-mode="8192" onclick="game2048.init(8192)">8192</button>
            <button class="btn mode-btn" data-mode="16384" onclick="game2048.init(16384)">16384</button>
            <button class="btn mode-btn" data-mode="32768" onclick="game2048.init(32768)">32768</button>
            <button class="btn mode-btn" data-mode="65536" onclick="game2048.init(65536)">65536</button>
            <button class="btn mode-btn" data-mode="131072" onclick="game2048.init(131072)" style="background:#000; color:#00f2ff;">131072</button>
        </div>
        <button class="btn mode-btn" data-mode="Blitz" style="width:320px; background:#f65e3b;" onclick="game2048.init(Infinity, 60)">1 Min Blitz</button>
        <button class="btn mode-btn" data-mode="Endless" style="width:320px; background:#333;" onclick="game2048.init(Infinity)">Endless</button>
    </div>

    <div id="view-2048" class="view">
        <div class="top-header">
            <h1 id="display-target">2048</h1>
            <div class="score-container">
                <div class="score-box"><span class="score-label">SCORE</span><span id="score-2048" class="score-val">0</span></div>
            </div>
        </div>
        <div id="timer-row" style="display:none; margin-bottom:10px; width:340px;">
            <div class="score-box" style="background:#f65e3b; width:100%;"><span class="score-label" style="color:white">TIME LEFT</span><b id="timer-val" style="font-size:20px; color:white;">0:00</b></div>
        </div>
        <div class="game-wrapper" id="board-2048">
            <div class="grid-bg">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
            <div class="tile-layer" id="tile-layer"></div>
            <div class="overlay" id="over-2048">
                <h2 style="color:#776e65; font-size:36px; margin-bottom:20px;">Game Over!</h2>
                <button class="btn" onclick="game2048.init(game2048.target, game2048.initTime)">Try Again</button>
                <button class="btn" style="background:#555" onclick="sys.nav('view-modes')">Menu</button>
            </div>
        </div>
        <div style="display:flex; gap:15px; margin-top:20px;">
            <button class="btn" style="width:80px; background:#bbada0" onclick="game2048.undo()">â†©</button>
            <button class="btn" id="btn-del" style="width:80px; background:#bbada0" onclick="game2048.usePowerup('del')">âœ–</button>
        </div>
    </div>

    <div id="view-bp" class="view" style="background:var(--bp-bg)">
        <div class="top-header">
            <div style="color:#ffcc00; font-weight:bold; font-size:20px;">ðŸ‘‘ BEST: <span id="best-bp">0</span></div>
            <button class="btn" style="background:none; box-shadow:none; font-size:24px;" onclick="sys.nav('view-home')">âœ•</button>
        </div>
        <div class="bp-score-large" id="score-bp">0</div>
        <div class="bp-grid-wrapper">
            <div class="bp-grid" id="bp-grid"></div>
        </div>
        <div class="tray" id="tray"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCBFxvZXyI4-vZx5F_wsfwoDjx0Z1j9CgE",
            authDomain: "e2048-f9e5e.firebaseapp.com",
            databaseURL: "https://e2048-f9e5e-default-rtdb.firebaseio.com",
            projectId: "e2048-f9e5e",
            storageBucket: "e2048-f9e5e.firebasestorage.app",
            messagingSenderId: "1055536544520",
            appId: "1:1055536544520:web:e399086e1005510668997a"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const fbAuth = firebase.auth();

        /* --- SOUND ENGINE --- */
        const sfx = {
            ctx: null,
            play(freq, type, dur, vol) {
                try {
                    if (!this.ctx) {
                        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                    }
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type; 
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime); 
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                    osc.connect(gain); 
                    gain.connect(this.ctx.destination); 
                    osc.start(); 
                    osc.stop(this.ctx.currentTime + dur);
                } catch(e) {
                    console.log("Audio Error:", e);
                }
            },
            merge() { this.play(400, 'sine', 0.15, 0.1); }, 
            highMerge() { this.play(800, 'triangle', 0.3, 0.1); },
            wood() { this.play(200, 'square', 0.05, 0.05); }, 
            blast() { this.play(100, 'sawtooth', 0.3, 0.15); }
        };

        /* --- SYSTEM CORE --- */
        const sys = {
            nav(id) { 
                document.querySelectorAll('.view').forEach(v => {
                    v.classList.remove('active-view');
                }); 
                document.getElementById(id).classList.add('active-view'); 
                
                if(id === 'view-bp') {
                    gameBP.init(); 
                }
            },
            toast(m) { 
                const t = document.getElementById('toast'); 
                t.innerText = m; 
                t.style.top = "20px"; 
                setTimeout(() => {
                    t.style.top = "-100px";
                }, 2500); 
            }
        };

        /* --- AUTHENTICATION --- */
        const authS = {
            login() { 
                const email = document.getElementById('auth-u').value + "@e2048.com";
                const pass = document.getElementById('auth-p').value;
                fbAuth.signInWithEmailAndPassword(email, pass).catch(e => sys.toast("Login Failed")); 
            },
            register() { 
                const email = document.getElementById('auth-u').value + "@e2048.com";
                const pass = document.getElementById('auth-p').value;
                fbAuth.createUserWithEmailAndPassword(email, pass).catch(e => sys.toast("Registration Failed")); 
            },
            guest() { 
                fbAuth.signInAnonymously(); 
            },
            logout() { 
                fbAuth.signOut().then(() => location.reload()); 
            }
        };

        fbAuth.onAuthStateChanged(user => { 
            if(user) { 
                sys.nav('view-home'); 
            } else { 
                sys.nav('view-auth'); 
            }
        });

        /* --- ADMIN SYSTEM --- */
        const adminS = {
            promptLogin() { 
                if (prompt("Admin Code:") === "crazyadmin99") { 
                    document.getElementById('admin-panel').style.display = 'flex'; 
                    sys.toast("Admin Authenticated"); 
                }
            },
            send() { 
                const msg = document.getElementById('admin-msg').value;
                db.ref('globalSettings/announcement').set(msg); 
                sys.toast("Broadcast Sent"); 
            },
            clear() { 
                db.ref('globalSettings/announcement').set(""); 
            }
        };

        db.ref('globalSettings/announcement').on('value', snap => {
            const msg = snap.val(); 
            const el = document.getElementById('global-announcement');
            if(msg) { 
                el.innerText = "ðŸ“¢ " + msg; 
                el.style.display = 'block'; 
            } else { 
                el.style.display = 'none'; 
            }
        });

        /* --- OWNER SYSTEM --- */
        const owner = {
            isLogged: false, 
            settings: { 
                stopUntil: 0, 
                maint: false, 
                difficulty: 2, 
                lockedModes: [] 
            },
            
            init() { 
                db.ref('globalSettings').on('value', snap => { 
                    const data = snap.val();
                    if (data) {
                        if (data.stopUntil !== undefined) this.settings.stopUntil = data.stopUntil;
                        if (data.maint !== undefined) this.settings.maint = data.maint;
                        if (data.difficulty !== undefined) this.settings.difficulty = data.difficulty;
                        if (data.lockedModes !== undefined) this.settings.lockedModes = data.lockedModes;
                    }
                    this.apply(); 
                }); 
                
                setInterval(() => {
                    this.apply();
                }, 1000); 
            },
            
            promptLogin() { 
                if (prompt("Owner Code:") === "luan2022") { 
                    this.isLogged = true; 
                    document.getElementById('owner-link').style.display = 'block'; 
                    this.renderControls(); 
                }
            },
            
            toggleMaint() { 
                this.settings.maint = !this.settings.maint; 
                this.save(); 
            },
            
            toggleStop() {
                const val = parseFloat(document.getElementById('stop-val').value) || 0;
                const unit = parseFloat(document.getElementById('stop-unit').value);
                this.settings.stopUntil = Date.now() + (val * unit); 
                this.save();
            },
            
            cycleDiff() { 
                this.settings.difficulty = (this.settings.difficulty % 4) + 1; 
                this.save(); 
            },
            
            toggleLock(mode) {
                if (!this.settings.lockedModes) this.settings.lockedModes = [];
                if (this.settings.lockedModes.includes(mode)) {
                    this.settings.lockedModes = this.settings.lockedModes.filter(m => m !== mode);
                } else {
                    this.settings.lockedModes.push(mode);
                }
                this.save();
            },

            save() { 
                db.ref('globalSettings').set({
                    stopUntil: this.settings.stopUntil,
                    maint: this.settings.maint,
                    difficulty: this.settings.difficulty,
                    lockedModes: this.settings.lockedModes || [],
                    announcement: document.getElementById('global-announcement').innerText.replace("ðŸ“¢ ", "")
                }); 
            },
            
            apply() {
                const isStopped = (this.settings.maint || Date.now() < this.settings.stopUntil);
                const overlay = document.getElementById('stop-overlay');
                
                if (isStopped && !this.isLogged) {
                    overlay.style.display = 'flex';
                } else {
                    overlay.style.display = 'none';
                }
                
                if (Date.now() < this.settings.stopUntil) {
                    document.getElementById('stop-timer-display').innerText = `System resumes in: ${Math.floor((this.settings.stopUntil - Date.now())/1000)}s`;
                } else {
                    document.getElementById('stop-timer-display').innerText = "";
                }
                
                // Apply locks to buttons
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    const mode = btn.dataset.mode;
                    const isLocked = (this.settings.lockedModes || []).includes(mode);
                    btn.disabled = (!this.isLogged && isLocked);
                });

                if (this.isLogged) {
                    this.renderControls();
                }
            },
            
            renderControls() { 
                const mBtn = document.getElementById('maint-btn'); 
                mBtn.innerText = "MAINTENANCE: " + (this.settings.maint ? "ON" : "OFF"); 
                mBtn.style.background = this.settings.maint ? "#d33" : "#8f7a66"; 
                
                const diffNames = ["", "Easy", "Normal", "Hard", "Chaos"];
                document.getElementById('owner-diff-text').innerText = diffNames[this.settings.difficulty];

                const lockContainer = document.getElementById('owner-lock-controls');
                lockContainer.innerHTML = '';
                const allModes = ["1024", "2048", "4096", "8192", "16384", "32768", "65536", "131072", "Blitz", "Endless"];
                
                allModes.forEach(m => {
                    const b = document.createElement('button'); 
                    b.className = 'btn'; 
                    b.style.fontSize = '10px'; 
                    b.style.padding = '5px';
                    const isLocked = (this.settings.lockedModes || []).includes(m);
                    b.innerText = (isLocked ? "Unlock " : "Lock ") + m;
                    b.style.background = isLocked ? "#d33" : "#8f7a66";
                    b.onclick = () => this.toggleLock(m);
                    lockContainer.appendChild(b);
                });
            }
        };

        /* --- 2048 ENGINE --- */
        const game2048 = {
            grid: [], 
            score: 0, 
            target: 2048, 
            idCounter: 0, 
            history: [], 
            timer: null, 
            timeLeft: 0, 
            isTimer: false,
            powerup: null,
            
            init(t, sec = 0) {
                const modeName = sec > 0 ? "Blitz" : (t === Infinity ? "Endless" : t.toString());
                if ((owner.settings.lockedModes || []).includes(modeName) && !owner.isLogged) {
                    return sys.toast("Mode Locked!");
                }
                
                clearInterval(this.timer); 
                this.target = t; 
                this.score = 0; 
                this.grid = Array(16).fill(null); 
                this.history = []; 
                this.isTimer = sec > 0;
                
                document.getElementById('display-target').innerText = t === Infinity ? "Endless" : t;
                document.getElementById('tile-layer').innerHTML = ''; 
                document.getElementById('over-2048').style.display = 'none';
                document.getElementById('timer-row').style.display = this.isTimer ? 'flex' : 'none';
                
                if (this.isTimer) {
                    this.timeLeft = sec; 
                    this.startTimer(); 
                }
                
                this.spawn(); 
                this.spawn(); 
                this.render(); 
                sys.nav('view-2048');
            },
            
            startTimer() { 
                this.timer = setInterval(() => { 
                    this.timeLeft--; 
                    const m = Math.floor(this.timeLeft / 60);
                    const s = this.timeLeft % 60;
                    document.getElementById('timer-val').innerText = `${m}:${s.toString().padStart(2, '0')}`; 
                    
                    if (this.timeLeft <= 0) { 
                        clearInterval(this.timer); 
                        document.getElementById('over-2048').style.display = 'flex'; 
                    }
                }, 1000); 
            },
            
            spawn() {
                const empty = this.grid.map((v, i) => v === null ? i : null).filter(v => v !== null);
                if (empty.length > 0) {
                    let val = Math.random() < 0.9 ? 2 : 4;
                    if (owner.settings.difficulty === 4 && Math.random() < 0.1) {
                        val = 131072;
                    }
                    const randomSpot = empty[Math.floor(Math.random() * empty.length)];
                    this.grid[randomSpot] = { id: this.idCounter++, val: val, isNew: true };
                }
            },
            
            render() {
                const layer = document.getElementById('tile-layer');
                const currentIds = new Set(this.grid.filter(t => t !== null).map(t => t.id));
                
                Array.from(layer.children).forEach(n => { 
                    if (!currentIds.has(parseInt(n.dataset.id))) {
                        n.remove(); 
                    }
                });
                
                this.grid.forEach((t, i) => {
                    if (t === null) return;
                    let n = document.querySelector(`.tile[data-id='${t.id}']`);
                    
                    if (!n) { 
                        n = document.createElement('div'); 
                        n.dataset.id = t.id; 
                        n.className = 'tile'; 
                        
                        n.onclick = () => {
                            if (this.powerup === 'del') {
                                this.history.push({ grid: JSON.parse(JSON.stringify(this.grid)), score: this.score });
                                this.grid[i] = null;
                                this.powerup = null;
                                document.getElementById('btn-del').style.background = '#bbada0';
                                this.render();
                            }
                        };
                        
                        layer.appendChild(n); 
                    }
                    
                    n.className = `tile t${t.val} ${t.isNew ? 't-new' : ''}`;
                    n.style.transform = `translate(${(i % 4) * 82.5}px, ${Math.floor(i / 4) * 82.5}px)`;
                    n.innerText = t.val; 
                    t.isNew = false;
                });
                
                document.getElementById('score-2048').innerText = this.score;
            },
            
            undo() { 
                if (this.history.length > 0) { 
                    const s = this.history.pop(); 
                    this.grid = s.grid; 
                    this.score = s.score; 
                    this.render(); 
                } else {
                    sys.toast("Nothing to undo");
                }
            },
            
            usePowerup(type) {
                if (type === 'del') {
                    this.powerup = 'del';
                    document.getElementById('btn-del').style.background = '#d33';
                    sys.toast("Click a tile to delete it");
                }
            },
            
            move(dir) {
                if (this.powerup) return; // Don't move if using powerup
                
                const prevGrid = JSON.stringify(this.grid);
                this.history.push({grid: JSON.parse(prevGrid), score: this.score}); 
                
                if (this.history.length > 30) {
                    this.history.shift();
                }
                
                let moved = false;
                
                const rotate = (grid) => {
                    let next = Array(16).fill(null);
                    for (let r = 0; r < 4; r++) {
                        for (let c = 0; c < 4; c++) {
                            next[c * 4 + (3 - r)] = grid[r * 4 + c];
                        }
                    }
                    return next;
                };
                
                let tempGrid = [...this.grid];
                const rotCount = { 'L': 0, 'U': 1, 'R': 2, 'D': 3 }[dir];
                
                for (let i = 0; i < rotCount; i++) {
                    tempGrid = rotate(tempGrid);
                }
                
                for (let r = 0; r < 4; r++) {
                    let row = []; 
                    for (let c = 0; c < 4; c++) {
                        row.push(tempGrid[r * 4 + c]);
                    }
                    
                    let filtered = row.filter(x => x !== null);
                    
                    for (let i = 0; i < filtered.length - 1; i++) {
                        if (filtered[i].val === filtered[i+1].val) {
                            filtered[i].val *= 2; 
                            this.score += filtered[i].val; 
                            filtered.splice(i+1, 1); 
                            moved = true; 
                            sfx.merge();
                        }
                    }
                    
                    while (filtered.length < 4) {
                        filtered.push(null);
                    }
                    
                    for (let c = 0; c < 4; c++) {
                        tempGrid[r * 4 + c] = filtered[c];
                    }
                }
                
                for (let i = 0; i < (4 - rotCount) % 4; i++) {
                    tempGrid = rotate(tempGrid);
                }
                
                if (JSON.stringify(tempGrid) !== prevGrid) { 
                    this.grid = tempGrid; 
                    moved = true; 
                }
                
                if (moved) { 
                    this.spawn(); 
                    this.render(); 
                } else { 
                    this.history.pop(); 
                }
            }
        };

        /* --- BLOCK PUZZLE ENGINE --- */
        const gameBP = {
            board: Array(64).fill(0), 
            score: 0,
            shapes: [ 
                {m: [[1,1],[1,1]], c: 'bp-filled-green'}, 
                {m: [[1,1,1,1]], c: 'bp-filled-beige'}, 
                {m: [[1,1,1],[0,1,0]], c: 'bp-filled-green'}, 
                {m: [[1,1,0],[0,1,1]], c: 'bp-filled-beige'},
                {m: [[1]], c: 'bp-filled-green'}, 
                {m: [[1,1,1]], c: 'bp-filled-beige'},
                {m: [[1,0],[1,1],[1,0]], c: 'bp-filled-green'}
            ],
            
            init() {
                this.board.fill(0); 
                this.score = 0; 
                document.getElementById('score-bp').innerText = 0;
                
                const gridEl = document.getElementById('bp-grid'); 
                gridEl.innerHTML = ''; 
                
                for (let i = 0; i < 64; i++) { 
                    const slot = document.createElement('div'); 
                    slot.className = 'bp-slot'; 
                    slot.id = `bp-c-${i}`; 
                    gridEl.appendChild(slot); 
                }
                
                this.spawn();
            },
            
            spawn() {
                const tray = document.getElementById('tray'); 
                tray.innerHTML = '';
                
                for (let i = 0; i < 3; i++) {
                    const randomShape = this.shapes[Math.floor(Math.random() * this.shapes.length)];
                    const shapeEl = document.createElement('div');
                    
                    shapeEl.className = 'shape'; 
                    shapeEl.dataset.matrix = JSON.stringify(randomShape.m); 
                    shapeEl.style.gridTemplateColumns = `repeat(${randomShape.m[0].length}, 20px)`;
                    
                    randomShape.m.flat().forEach(val => { 
                        const block = document.createElement('div'); 
                        block.className = 'mini-block'; 
                        if (val) {
                            block.classList.add(randomShape.c); 
                        }
                        shapeEl.appendChild(block); 
                    });
                    
                    const handleDragStart = (e, isTouch) => {
                        this.drag(isTouch ? e.touches[0] : e, shapeEl, randomShape.m, randomShape.c);
                    };
                    
                    shapeEl.addEventListener('mousedown', e => handleDragStart(e, false)); 
                    shapeEl.addEventListener('touchstart', e => handleDragStart(e, true), {passive: false});
                    
                    tray.appendChild(shapeEl);
                }
            },
            
            drag(pt, el, matrix, cls) {
                const clone = el.cloneNode(true); 
                clone.classList.add('dragging'); 
                clone.style.gridTemplateColumns = `repeat(${matrix[0].length}, 40px)`;
                
                Array.from(clone.children).forEach(c => { 
                    c.style.width = '40px'; 
                    c.style.height = '40px'; 
                }); 
                
                document.body.appendChild(clone);
                
                const moveHandler = ev => { 
                    ev.preventDefault(); 
                    const p = ev.touches ? ev.touches[0] : ev; 
                    clone.style.left = p.clientX - 20 + 'px'; 
                    clone.style.top = p.clientY - 60 + 'px'; 
                };
                
                const endHandler = ev => { 
                    const p = ev.changedTouches ? ev.changedTouches[0] : ev;
                    const rect = document.getElementById('bp-grid').getBoundingClientRect();
                    const col = Math.round((p.clientX - rect.left - 20) / 42);
                    const row = Math.round((p.clientY - rect.top - 60) / 42);
                    
                    if (this.canPlace(matrix, row, col)) {
                        for (let i = 0; i < matrix.length; i++) {
                            for (let j = 0; j < matrix[0].length; j++) {
                                if (matrix[i][j]) {
                                    const idx = (row + i) * 8 + (col + j);
                                    this.board[idx] = 1; 
                                    document.getElementById(`bp-c-${idx}`).className = `bp-slot ${cls}`;
                                }
                            }
                        }
                        
                        this.score += 10; 
                        document.getElementById('score-bp').innerText = this.score; 
                        
                        el.style.visibility = 'hidden'; 
                        el.dataset.used = 'true';
                        
                        const allUsed = Array.from(document.getElementById('tray').children).every(n => n.dataset.used);
                        if (allUsed) {
                            this.spawn();
                        }
                        
                        this.checkLines(); 
                    }
                    
                    clone.remove(); 
                    window.removeEventListener('mousemove', moveHandler); 
                    window.removeEventListener('mouseup', endHandler); 
                    window.removeEventListener('touchmove', moveHandler); 
                    window.removeEventListener('touchend', endHandler);
                };
                
                window.addEventListener('mousemove', moveHandler); 
                window.addEventListener('mouseup', endHandler); 
                window.addEventListener('touchmove', moveHandler, {passive: false}); 
                window.addEventListener('touchend', endHandler);
            },
            
            canPlace(m, r, c) { 
                if (r < 0 || c < 0 || r + m.length > 8 || c + m[0].length > 8) {
                    return false; 
                }
                
                for (let i = 0; i < m.length; i++) {
                    for (let j = 0; j < m[0].length; j++) {
                        if (m[i][j] && this.board[(r + i) * 8 + (c + j)]) {
                            return false; 
                        }
                    }
                }
                return true; 
            },
            
            checkLines() {
                let rowsToClear = [];
                let colsToClear = [];
                
                for (let i = 0; i < 8; i++) { 
                    // Check rows
                    let rowFull = true;
                    for (let j = 0; j < 8; j++) {
                        if (this.board[i * 8 + j] === 0) rowFull = false;
                    }
                    if (rowFull) rowsToClear.push(i); 
                    
                    // Check cols
                    let colFull = true;
                    for (let j = 0; j < 8; j++) {
                        if (this.board[j * 8 + i] === 0) colFull = false;
                    }
                    if (colFull) colsToClear.push(i);
                }
                
                // Clear the identified rows
                rowsToClear.forEach(r => { 
                    for (let c = 0; c < 8; c++) { 
                        this.board[r * 8 + c] = 0; 
                        document.getElementById(`bp-c-${r * 8 + c}`).className = 'bp-slot'; 
                    } 
                });
                
                // Clear the identified columns
                colsToClear.forEach(c => { 
                    for (let r = 0; r < 8; r++) { 
                        this.board[r * 8 + c] = 0; 
                        document.getElementById(`bp-c-${r * 8 + c}`).className = 'bp-slot'; 
                    } 
                });
                
                if (rowsToClear.length > 0 || colsToClear.length > 0) { 
                    this.score += (rowsToClear.length + colsToClear.length) * 100; 
                    document.getElementById('score-bp').innerText = this.score;
                    sfx.blast();
                }
            }
        };

        /* --- INITIALIZATION & EVENTS --- */
        window.onload = () => { 
            owner.init(); 
        };
        
        window.addEventListener('keydown', e => { 
            if (document.getElementById('view-2048').classList.contains('active-view')) {
                if (e.key === 'ArrowUp') game2048.move('U');
                if (e.key === 'ArrowDown') game2048.move('D');
                if (e.key === 'ArrowLeft') game2048.move('L');
                if (e.key === 'ArrowRight') game2048.move('R');
            }
        });
        
        const boardEl = document.getElementById('board-2048'); 
        let touchStartX, touchStartY;
        
        boardEl.addEventListener('touchstart', e => { 
            touchStartX = e.touches[0].clientX; 
            touchStartY = e.touches[0].clientY; 
        }, {passive: false});
        
        boardEl.addEventListener('touchend', e => {
            if (!document.getElementById('view-2048').classList.contains('active-view')) return;
            
            let dx = e.changedTouches[0].clientX - touchStartX;
            let dy = e.changedTouches[0].clientY - touchStartY;
            
            if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                if (Math.abs(dx) > Math.abs(dy)) {
                    game2048.move(dx > 0 ? 'R' : 'L');
                } else {
                    game2048.move(dy > 0 ? 'D' : 'U');
                }
            }
        });
    </script>
</body>
</html>
