<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>e2048</title>
    <style>
        :root {
            --bg: #faf8ef; --grid: #bbada0; --tile: #cdc1b4; 
            --text: #776e65; --accent: #8f7a66; --white: #ffffff;
            --neon: #00f2ff; --grass: #7cfc00;
        }

        /* THEMES */
        .theme-dark { --bg: #121212; --grid: #2a2a2a; --tile: #3d3d3d; --text: #e0e0e0; --accent: #bb86fc; }
        .theme-neon { --bg: #000; --grid: #1a1a1a; --tile: #333; --text: var(--neon); --accent: #ff0055; }
        .theme-grass { --bg: #2d5a27; --grid: #1e3d1a; --tile: #3e6b37; --text: #ffffff; --accent: #ffd700; }

        body { 
            background: var(--bg); color: var(--text); font-family: 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; align-items: center; transition: 0.3s;
        }

        /* UI OVERLAYS */
        .view { 
            display: none; position: absolute; width: 100%; height: 100%; 
            flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg); z-index: 10; padding: 20px; box-sizing: border-box;
        }
        .active-view { display: flex; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* GAME BOARD */
        .game-container { position: relative; width: 340px; }
        #grid { 
            display: grid; background: var(--grid); padding: 10px; border-radius: 8px; 
            grid-gap: 10px; position: relative;
        }
        .tile { 
            width: 70px; height: 70px; border-radius: 4px; display: flex; 
            justify-content: center; align-items: center; font-weight: bold;
            transition: 0.1s transform, 0.1s top, 0.1s left;
        }

        /* BUTTONS */
        .btn { 
            background: var(--accent); color: white; border: none; padding: 12px 20px; 
            border-radius: 6px; font-weight: bold; cursor: pointer; margin: 5px;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn-small { padding: 5px 10px; font-size: 12px; }

        /* STATS & LISTS */
        .list-container { 
            width: 100%; max-width: 300px; max-height: 200px; 
            overflow-y: auto; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 10px;
        }
        .list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="view-auth" class="view active-view">
        <h1 style="font-size: 60px; margin: 0;">e2048</h1>
        <p>Evolutionary Branch</p>
        <input type="text" id="username" placeholder="Username" style="padding:10px; border-radius:5px; border:1px solid #ccc; margin-bottom:10px; width:200px;">
        <button class="btn" onclick="app.login()">Login / Register</button>
        <p style="font-size: 12px; opacity: 0.6;">No password required (Local Cloud Simulation)</p>
    </div>

    <div id="view-home" class="view">
        <h1 id="welcome-msg">Hi, Player</h1>
        <button class="btn" onclick="app.nav('view-modes')">Play e2048</button>
        <button class="btn" onclick="app.nav('view-discovery')" style="background:#5c85d6">More Games</button>
        <button class="btn" onclick="app.nav('view-stats')" style="background:#444">Stats & Achievements</button>
        <button class="btn" onclick="app.nav('view-settings')" style="background:#777">Settings</button>
    </div>

    <div id="view-modes" class="view">
        <h2>Select Mode</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn" onclick="game.start(1024)">1024</button>
            <button class="btn" onclick="game.start(2048)">2048</button>
            <button class="btn" onclick="game.start(16384)">16k</button>
            <button class="btn" onclick="game.start(131072)">131k</button>
        </div>
        <button class="btn" style="width:100%;" onclick="game.start(Infinity)">Endless</button>
        <hr style="width:100%; opacity:0.2;">
        <h3>Grid Size</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn-small" onclick="game.setSize(3)">3x3</button>
            <button class="btn-small" onclick="game.setSize(4)">4x4</button>
            <button class="btn-small" onclick="game.setSize(5)">5x5</button>
        </div>
        <button class="btn" onclick="app.nav('view-home')" style="background:#d33">Back</button>
    </div>

    <div id="view-stats" class="view">
        <h2>Player Stats</h2>
        <div class="list-container" id="stats-content"></div>
        <h2>Achievements</h2>
        <div class="list-container" id="achievements-content"></div>
        <button class="btn" onclick="app.nav('view-home')">Back</button>
    </div>

    <div id="view-settings" class="view">
        <h2>Settings</h2>
        <button class="btn" onclick="app.setTheme('dark')">Dark Mode</button>
        <button class="btn" onclick="app.setTheme('neon')">Neon Theme</button>
        <button class="btn" onclick="app.setTheme('grass')">Grass Theme</button>
        <button class="btn" onclick="app.toggleHaptics()">Toggle Haptics</button>
        <button class="btn" onclick="app.nav('view-home')">Back</button>
    </div>

    <div id="view-game" class="view">
        <div style="display:flex; justify-content:space-between; width:340px;">
            <h2 id="current-mode-name">2048</h2>
            <div style="text-align:right;">
                <span style="font-size:10px;">SCORE</span><br><b id="score">0</b>
            </div>
        </div>
        <div class="game-container">
            <div id="grid"></div>
        </div>
        <div class="controls" style="margin-top:20px;">
            <button class="btn" onclick="game.undo()">Undo</button>
            <button class="btn" onclick="app.nav('view-home')" style="background:#d33">Quit</button>
        </div>
    </div>

    <script>
        /* --- APP STATE & ENGINE --- */
        const app = {
            user: null,
            settings: { theme: 'classic', haptics: true, sound: true },
            stats: { highTile: 0, totalGames: 0, bestScore: 0, merges: 0 },
            
            init() {
                this.loadData();
                if(this.user) this.nav('view-home');
            },

            login() {
                const name = document.getElementById('username').value;
                if(!name) return alert("Enter username");
                this.user = name;
                this.saveData();
                document.getElementById('welcome-msg').innerText = `Hi, ${name}`;
                this.nav('view-home');
                this.toast(`Authenticated as ${name}`);
            },

            nav(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
                document.getElementById(viewId).classList.add('active-view');
                if(viewId === 'view-stats') this.renderStats();
            },

            setTheme(t) {
                document.body.className = 'theme-' + t;
                this.settings.theme = t;
                this.saveData();
            },

            toast(msg) {
                console.log("Toast:", msg); // Implement visual toast if needed
            },

            saveData() {
                localStorage.setItem('e2048_user', this.user);
                localStorage.setItem('e2048_settings', JSON.stringify(this.settings));
                localStorage.setItem('e2048_stats', JSON.stringify(this.stats));
            },

            loadData() {
                this.user = localStorage.getItem('e2048_user');
                this.stats = JSON.parse(localStorage.getItem('e2048_stats')) || this.stats;
            },

            renderStats() {
                const sCont = document.getElementById('stats-content');
                sCont.innerHTML = `
                    <div class="list-item"><span>Highest Tile</span><span>${this.stats.highTile}</span></div>
                    <div class="list-item"><span>Best Score</span><span>${this.stats.bestScore}</span></div>
                    <div class="list-item"><span>Total Merges</span><span>${this.stats.merges}</span></div>
                `;
            }
        };

        /* --- 2048 GAME ENGINE --- */
        const game = {
            grid: [],
            size: 4,
            score: 0,
            target: 2048,
            history: [],

            setSize(s) { this.size = s; app.toast(`Grid set to ${s}x${s}`); },

            start(target) {
                this.target = target;
                this.score = 0;
                this.grid = Array(this.size * this.size).fill(0);
                document.getElementById('grid').style.gridTemplateColumns = `repeat(${this.size}, 1fr)`;
                app.nav('view-game');
                document.getElementById('current-mode-name').innerText = target === Infinity ? "Endless" : target;
                this.addTile(); this.addTile();
                this.render();
            },

            addTile() {
                let empty = this.grid.map((v, i) => v === 0 ? i : null).filter(v => v !== null);
                if(empty.length) {
                    const idx = empty[Math.floor(Math.random() * empty.length)];
                    this.grid[idx] = Math.random() > 0.1 ? 2 : 4;
                }
            },

            render() {
                const gElem = document.getElementById('grid');
                gElem.innerHTML = '';
                this.grid.forEach(v => {
                    const d = document.createElement('div');
                    d.className = 'tile';
                    d.innerText = v || '';
                    d.style.background = v ? this.getColor(v) : 'var(--tile)';
                    d.style.color = v > 4 ? '#fff' : 'var(--text)';
                    d.style.fontSize = this.size > 4 ? '18px' : '24px';
                    gElem.appendChild(d);
                });
                document.getElementById('score').innerText = this.score;
            },

            getColor(v) {
                const colors = {2:'#eee4da', 4:'#ede0c8', 8:'#f2b179', 16:'#f59563', 32:'#f67c5f', 64:'#f65e3b', 128:'#edcf72', 256:'#edcc61', 512:'#edc850', 1024:'#edc53f', 2048:'#edc22e'};
                return colors[v] || '#3c3a32';
            },

            undo() {
                if(this.history.length) {
                    const prev = this.history.pop();
                    this.grid = prev.g;
                    this.score = prev.s;
                    this.render();
                }
            }
            // Swipe logic and move algorithms would go here
        };

        app.init();
    </script>
</body>
</html>
